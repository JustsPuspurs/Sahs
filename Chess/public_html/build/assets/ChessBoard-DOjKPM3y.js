import{r as f,j as u,a as ce}from"./app-BK9e1gig.js";import{W as le,a as ue,b as me,c as de,d as Q,r as H,K as O,P as v,R as _,e as W,B as $,Q as X}from"./PC-C3JbfhU5.js";import{B as he,a as ge,b as fe,c as xe,d as we,e as be}from"./BlueKing-BUktslDH.js";class z{constructor(o){this.pieces=o}getPieceAt(o,s){return this.pieces.find(r=>r.matrixPosition.x===o&&r.matrixPosition.y===s)}move(o,s){const r=this.getPieceAt(o.x,o.y);if(!r){console.error("No piece found at the source position:",o);return}const d=this.getPieceAt(s.x,s.y);d&&d.white!==r.white&&(this.pieces=this.pieces.filter(p=>p!==d)),r.move(s.x,s.y)}clone(){const o=this.pieces.map(s=>s.clone());return new z(o)}}const J={"images/blue_pawn.png":he,"images/blue_rook.png":ge,"images/blue_knight.png":fe,"images/blue_bishop.png":xe,"images/blue_queen.png":we,"images/blue_king.png":be},ve={Queen:le,Rook:ue,Bishop:me,Knight:de},U=()=>{const c=[new O(4,0,!1),new v(0,6,!0),new v(1,6,!0),new v(2,6,!0),new v(3,6,!0),new v(4,6,!0),new v(5,6,!0),new v(6,6,!0),new v(7,6,!0),new _(0,7,!0),new W(1,7,!0),new $(2,7,!0),new X(3,7,!0),new O(4,7,!0),new $(5,7,!0),new W(6,7,!0),new _(7,7,!0)];return new z(c)},pe=(c,o)=>{const{x:s,y:r}=c.matrixPosition;switch(o.toLowerCase()){case"Rook":return new _(s,r,c.white);case"Bishop":return new $(s,r,c.white);case"Knight":return new W(s,r,c.white);default:return new X(s,r,c.white)}},N=(c,o)=>c.generateMoves(o).filter(s=>Q(o,{from:c.matrixPosition,to:s})!==o),V=(c,o,s)=>s.some(r=>r.x===c&&r.y===o),Pe=(c,o)=>{const s=String.fromCharCode(97+c),r=8-o;return s+r},G=(c,o,s)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[c.constructor.name]||"")+Pe(o,s),ke=({moveHistory:c,setMoveHistory:o,equippedSkinsMapping:s={}},r)=>{const[d,p]=f.useState(U()),[h,P]=f.useState(null),[Y,k]=f.useState(!0),[b,x]=f.useState(null),[Z,D]=f.useState(0),[ee,E]=f.useState(!1),[B,L]=f.useState(null),M=f.useRef(null),R=f.useRef(null),te=()=>{x("Black wins by resignation")};f.useImperativeHandle(r,()=>({retireGame:te}));const ne=()=>{let t="Win";b&&b.includes("Black wins")?t="Lose":b&&b.includes("Draw")&&(t="Draw"),ce.post("/game/result",{moves:c.map(e=>`${e.white} ${e.black}`).join(" | "),time:Z,side:"White",result:t}).then(()=>{E(!0)}).catch(()=>{})},se=()=>{b&&!ee&&ne(),p(U()),P(null),k(!0),x(null),o([]),M.current=null,R.current=null,D(0),E(!1)},oe=t=>{if(!B)return;const{board:e,pawn:m}=B,l=pe(m,t);e.pieces=e.pieces.map(i=>i===m?l:i),p(e),L(null),P(null);const n=I(e,!1);if(n){x(n);return}k(!1),setTimeout(()=>{const w=H(e,3,!1).move;if(w){const C=e.getPieceAt(w.from.x,w.from.y),j=G(C,w.to.x,w.to.y),a=Q(e,w);if(a!==e){p(a),o(y=>{const K=y.length-1,A={...y[K],black:j};return[...y.slice(0,K),A]});const g=I(a,!0);g&&x(g)}else x("Game over: AI resigns")}else x("Game over: AI resigns");k(!0)},500)},ie=(t,e)=>{if(b||B)return;const m=h?N(h,d):[];if(h&&V(t,e,m)){const n=Date.now();if(!M.current)M.current=n,R.current=n;else{const a=n-R.current;D(g=>g+a),R.current=n}const i=d.clone(),w=G(h,t,e);o(a=>[...a,{white:w,black:""}]);const C=m.find(a=>a.x===t&&a.y===e);if(C.castling==="kingside"?(i.move(h.matrixPosition,{x:6,y:e}),i.getPieceAt(7,e)&&i.move({x:7,y:e},{x:5,y:e})):C.castling==="queenside"?(i.move(h.matrixPosition,{x:2,y:e}),i.getPieceAt(0,e)&&i.move({x:0,y:e},{x:3,y:e})):i.move(h.matrixPosition,{x:t,y:e}),h.constructor.name==="Pawn"){const a=i.getPieceAt(t,e);if(a.white&&a.matrixPosition.y===0||!a.white&&a.matrixPosition.y===7){L({board:i,pawn:a});return}}p(i),P(null);const j=I(i,!1);if(j){x(j);return}k(!1),setTimeout(()=>{const g=H(i,3,!1).move;if(g){const y=i.getPieceAt(g.from.x,g.from.y),K=G(y,g.to.x,g.to.y),A=Q(i,g);if(A!==i){p(A),o(S=>{const F=S.length-1,ae={...S[F],black:K};return[...S.slice(0,F),ae]});const q=I(A,!0);q&&x(q)}else x("Game over: AI resigns")}else x("Game over: AI resigns");k(!0)},500);return}const l=d.getPieceAt(t,e);l&&l.white===Y?P(l):P(null)},I=(t,e)=>{let m=[];return t.pieces.forEach(l=>{l.white===e&&(m=m.concat(N(l,t)))}),m.length===0?T(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},T=(t,e)=>{const m=t.pieces.find(n=>n.constructor.name==="King"&&n.white===e);if(!m)return!1;let l=[];return t.pieces.forEach(n=>{n.white!==e&&(l=l.concat(n.generateMoves(t)))}),l.some(n=>n.x===m.matrixPosition.x&&n.y===m.matrixPosition.y)},re=h?N(h,d):[];return u.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[u.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((m,l)=>u.jsxs("div",{className:`square ${(e+l)%2===0?"light":"dark"}`,onClick:()=>ie(l,e),children:[V(l,e,re)&&u.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),d.pieces.map((n,i)=>{if(n&&n.matrixPosition.x===l&&n.matrixPosition.y===e){const w=n.constructor.name==="King"&&T(d,n.white);return u.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:h===n?"2px solid yellow":"none",borderRadius:"50%"},children:[w&&u.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),n.white&&s[n.constructor.name.toLowerCase()]?u.jsx("img",{src:J[s[n.constructor.name.toLowerCase()]],alt:n.constructor.name,style:{width:"100%",height:"100%"}}):n.render()]},i)}return null})]},`square-${e}-${l}`)))}),B&&u.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:u.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=s&&s[t]?J[s[t]]:ve[t];return u.jsx("img",{src:e,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>oe(t)},t)})})}),b&&u.jsx("div",{className:"modal",children:u.jsxs("div",{className:"modal-content",children:[u.jsx("h2",{children:b}),u.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:u.jsx("button",{onClick:se,children:"Restart"})})]})})]})},Re=f.forwardRef(ke);export{Re as default};
