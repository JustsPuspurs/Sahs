import{r as g,j as u,a as ae}from"./app-DmpkB3s6.js";import{W as le,a as ce,b as ue,c as me,d as $,r as H,R as A,K as R,B as I,Q as D,e as O,P as l}from"./PC-DX7X3wNl.js";import{B as he,a as de,b as fe,c as ge,d as we,e as xe}from"./BlueKing-BUktslDH.js";class E{constructor(o){this.pieces=o}getPieceAt(o,n){return this.pieces.find(r=>r.matrixPosition.x===o&&r.matrixPosition.y===n)}move(o,n){const r=this.getPieceAt(o.x,o.y);if(!r){console.error("No piece found at the source position:",o);return}const f=this.getPieceAt(n.x,n.y);f&&f.white!==r.white&&(this.pieces=this.pieces.filter(v=>v!==f)),r.move(n.x,n.y)}clone(){const o=this.pieces.map(n=>n.clone());return new E(o)}}const J={"images/blue_pawn.png":he,"images/blue_rook.png":de,"images/blue_knight.png":fe,"images/blue_bishop.png":ge,"images/blue_queen.png":we,"images/blue_king.png":xe},be={Queen:le,Rook:ce,Bishop:ue,Knight:me},U=()=>{const i=[new A(0,0,!1),new R(1,0,!1),new I(2,0,!1),new D(3,0,!1),new O(4,0,!1),new I(5,0,!1),new R(6,0,!1),new A(7,0,!1),new l(0,1,!1),new l(1,1,!1),new l(2,1,!1),new l(3,1,!1),new l(4,1,!1),new l(5,1,!1),new l(6,1,!1),new l(7,1,!1),new l(0,6,!0),new l(1,6,!0),new l(2,6,!0),new l(3,6,!0),new l(4,6,!0),new l(5,6,!0),new l(6,6,!0),new l(7,6,!0),new A(0,7,!0),new R(1,7,!0),new I(2,7,!0),new D(3,7,!0),new O(4,7,!0),new I(5,7,!0),new R(6,7,!0),new A(7,7,!0)];return new E(i)},pe=(i,o)=>{const{x:n,y:r}=i.matrixPosition;switch(o.toLowerCase()){case"rook":return new A(n,r,i.white);case"bishop":return new I(n,r,i.white);case"knight":return new R(n,r,i.white);default:return new D(n,r,i.white)}},_=(i,o)=>i.generateMoves(o).filter(n=>$(o,{from:i.matrixPosition,to:n})!==o),V=(i,o,n)=>n.some(r=>r.x===i&&r.y===o),ve=(i,o)=>{const n=String.fromCharCode(97+i),r=8-o;return n+r},W=(i,o,n)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[i.constructor.name]||"")+ve(o,n),Pe=({moveHistory:i,setMoveHistory:o,equippedSkinsMapping:n={}},r)=>{const[f,v]=g.useState(U()),[b,k]=g.useState(null),[X,y]=g.useState(!0),[p,w]=g.useState(null),[Y,T]=g.useState(0),[Z,z]=g.useState(!1),[j,L]=g.useState(null),G=g.useRef(null),C=g.useRef(null),ee=()=>{w("Black wins by resignation")};g.useImperativeHandle(r,()=>({retireGame:ee}));const te=()=>{let s="Win";p&&p.includes("Black wins")?s="Lose":p&&p.includes("Draw")&&(s="Draw"),ae.post("/game/result",{moves:i.map(e=>`${e.white} ${e.black}`).join(" | "),time:Y,side:"White",result:s}).then(()=>{z(!0)}).catch(()=>{})},ne=()=>{p&&!Z&&te(),v(U()),k(null),y(!0),w(null),o([]),G.current=null,C.current=null,T(0),z(!1)},se=s=>{if(!j)return;const{board:e,pawn:m}=j,a=pe(m,s);e.pieces=e.pieces.map(c=>c===m?a:c),v(e),L(null),k(null);const t=K(e,!1);if(t){w(t);return}y(!1),setTimeout(()=>{const x=H(e,3,!1).move;if(x){const M=e.getPieceAt(x.from.x,x.from.y),h=W(M,x.to.x,x.to.y),d=$(e,x);if(d!==e){v(d),o(B=>{const P=B.length-1,N={...B[P],black:h};return[...B.slice(0,P),N]});const S=K(d,!0);S&&w(S)}else w("Game over: AI resigns")}else w("Game over: AI resigns");y(!0)},500)},oe=(s,e)=>{if(p||j)return;const m=b?_(b,f):[];if(b&&V(s,e,m)){const t=Date.now();if(!G.current)G.current=t,C.current=t;else{const h=t-C.current;T(d=>d+h),C.current=t}const c=f.clone(),x=W(b,s,e);if(o(h=>[...h,{white:x,black:""}]),c.move(b.matrixPosition,{x:s,y:e}),b.constructor.name==="Pawn"){const h=c.getPieceAt(s,e);if(h.white&&h.matrixPosition.y===0||!h.white&&h.matrixPosition.y===7){L({board:c,pawn:h});return}}v(c),k(null);const M=K(c,!1);if(M){w(M);return}y(!1),setTimeout(()=>{const d=H(c,3,!1).move;if(d){const S=c.getPieceAt(d.from.x,d.from.y),B=W(S,d.to.x,d.to.y),P=$(c,d);if(P!==c){v(P),o(Q=>{const F=Q.length-1,ie={...Q[F],black:B};return[...Q.slice(0,F),ie]});const N=K(P,!0);N&&w(N)}else w("Game over: AI resigns")}else w("Game over: AI resigns");y(!0)},500);return}const a=f.getPieceAt(s,e);a&&a.white===X?k(a):k(null)},K=(s,e)=>{let m=[];return s.pieces.forEach(a=>{a.white===e&&(m=m.concat(_(a,s)))}),m.length===0?q(s,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},q=(s,e)=>{const m=s.pieces.find(t=>t.constructor.name==="King"&&t.white===e);if(!m)return!1;let a=[];return s.pieces.forEach(t=>{t.white!==e&&(a=a.concat(t.generateMoves(s)))}),a.some(t=>t.x===m.matrixPosition.x&&t.y===m.matrixPosition.y)},re=b?_(b,f):[];return u.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[u.jsx("div",{className:"chessboard",children:Array(8).fill().map((s,e)=>Array(8).fill().map((m,a)=>u.jsxs("div",{className:`square ${(e+a)%2===0?"light":"dark"}`,onClick:()=>oe(a,e),children:[V(a,e,re)&&u.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),f.pieces.map((t,c)=>{if(t&&t.matrixPosition.x===a&&t.matrixPosition.y===e){const x=t.constructor.name==="King"&&q(f,t.white);return u.jsxs("span",{className:"piece",style:{zIndex:2,border:b===t?"2px solid yellow":"none",borderRadius:"50%"},children:[x&&u.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none"}}),t.white&&n[t.constructor.name]?u.jsx("img",{src:J[n[t.constructor.name]],alt:t.constructor.name,style:{width:"100%",height:"100%"}}):t.render()]},c)}return null})]},`square-${e}-${a}`)))}),j&&u.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:u.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(s=>{const e=n&&n[s]?J[n[s]]:be[s];return u.jsx("img",{src:e,alt:s,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>se(s)},s)})})}),p&&u.jsx("div",{className:"modal",children:u.jsxs("div",{className:"modal-content",children:[u.jsx("h2",{children:p}),u.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:u.jsx("button",{onClick:ne,children:"Restart"})})]})})]})},Ae=g.forwardRef(Pe);export{Ae as default};
