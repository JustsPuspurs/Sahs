import{r as x,j as h,a as ue}from"./app-lxin3FpH.js";import{W as he,a as me,b as de,c as ge,d as Q,r as H,K as U,P as b,R as T,e as W,B as _,Q as X}from"./PC-BtEVwGxe.js";import{B as fe,a as xe,b as pe,c as we,d as ye,e as ke}from"./BlueKing-BUktslDH.js";class ${constructor(s){this.pieces=s}getPieceAt(s,o){return this.pieces.find(a=>a.matrixPosition.x===s&&a.matrixPosition.y===o)}move(s,o){const a=this.getPieceAt(s.x,s.y);if(!a){console.error("No piece found at the source position:",s);return}const m=this.getPieceAt(o.x,o.y);m&&m.white!==a.white&&(this.pieces=this.pieces.filter(y=>y!==m)),a.move(o.x,o.y)}clone(){const s=this.pieces.map(o=>o.clone());return new $(s)}}const M={blue_pawn:fe,blue_rook:xe,blue_knight:pe,blue_bishop:we,blue_queen:ye,blue_king:ke},be={Queen:he,Rook:me,Bishop:de,Knight:ge},J=()=>{const r=[new U(4,0,!1),new b(0,6,!0),new b(1,6,!0),new b(2,6,!0),new b(3,6,!0),new b(4,6,!0),new b(5,6,!0),new b(6,6,!0),new b(7,6,!0),new T(0,7,!0),new W(1,7,!0),new _(2,7,!0),new X(3,7,!0),new U(4,7,!0),new _(5,7,!0),new W(6,7,!0),new T(7,7,!0)];return new $(r)},Pe=(r,s)=>{const{x:o,y:a}=r.matrixPosition;switch(s.toLowerCase()){case"rook":return new T(o,a,r.white);case"bishop":return new _(o,a,r.white);case"knight":return new W(o,a,r.white);default:return new X(o,a,r.white)}},G=(r,s)=>r.generateMoves(s).filter(o=>Q(s,{from:r.matrixPosition,to:o})!==s),V=(r,s,o)=>o.some(a=>a.x===r&&a.y===s),ve=(r,s)=>{const o=String.fromCharCode(97+r),a=8-s;return o+a},q=(r,s,o)=>{const a={Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"},m=Y(r);return(a[m.charAt(0).toUpperCase()+m.slice(1)]||"")+ve(s,o)},Y=r=>r.constructor.type||r.constructor.name.toLowerCase(),Ae=({moveHistory:r,setMoveHistory:s,equippedSkinsMapping:o={}},a)=>{const[m,y]=x.useState(J()),[d,P]=x.useState(null),[Z,v]=x.useState(!0),[k,p]=x.useState(null),[ee,E]=x.useState(0),[te,z]=x.useState(!1),[R,D]=x.useState(null),K=x.useRef(null),I=x.useRef(null),ne=t=>{const e=Y(t);let i=o[e];return i&&(i=i.replace("images/","").replace(".png",""),M.hasOwnProperty(i))?M[i]:null},se=()=>{p("Black wins by resignation")};x.useImperativeHandle(a,()=>({retireGame:se}));const oe=()=>{let t="Win";k&&k.includes("Black wins")?t="Lose":k&&k.includes("Draw")&&(t="Draw"),ue.post("/game/result",{moves:r.map(e=>`${e.white} ${e.black}`).join(" | "),time:ee,side:"White",result:t}).then(()=>z(!0)).catch(()=>{})},ie=()=>{k&&!te&&oe(),y(J()),P(null),v(!0),p(null),s([]),K.current=null,I.current=null,E(0),z(!1)},re=t=>{if(console.log("Promotion choice:",t),!R)return;const{board:e,pawn:i}=R,u=Pe(i,t);e.pieces=e.pieces.map(n=>n===i?u:n),y(e),D(null),P(null);const c=C(e,!1);if(c){p(c);return}v(!1),setTimeout(()=>{const w=H(e,3,!1).move;if(w){const g=e.getPieceAt(w.from.x,w.from.y),j=q(g,w.to.x,w.to.y),l=Q(e,w);if(l!==e){y(l),s(A=>{const S=A.length-1,B={...A[S],black:j};return[...A.slice(0,S),B]});const f=C(l,!0);f&&p(f)}else p("Game over: AI resigns")}else p("Game over: AI resigns");v(!0)},500)},ae=(t,e)=>{if(k||R)return;const i=d?G(d,m):[];if(d&&V(t,e,i)){const c=Date.now();if(!K.current)K.current=c,I.current=c;else{const l=c-I.current;E(f=>f+l),I.current=c}const n=m.clone(),w=q(d,t,e);s(l=>[...l,{white:w,black:""}]);const g=i.find(l=>l.x===t&&l.y===e);if((g==null?void 0:g.castling)==="kingside"?(n.move(d.matrixPosition,{x:6,y:e}),n.getPieceAt(7,e)&&n.move({x:7,y:e},{x:5,y:e})):(g==null?void 0:g.castling)==="queenside"?(n.move(d.matrixPosition,{x:2,y:e}),n.getPieceAt(0,e)&&n.move({x:0,y:e},{x:3,y:e})):n.move(d.matrixPosition,{x:t,y:e}),d.constructor.type==="pawn"){const l=n.getPieceAt(t,e);if(l.white&&l.matrixPosition.y===0||!l.white&&l.matrixPosition.y===7){console.log("Pawn promotion triggered for:",l),D({board:n,pawn:l});return}}y(n),P(null);const j=C(n,!1);if(j){p(j);return}v(!1),setTimeout(()=>{const f=H(n,3,!1).move;if(f){const A=n.getPieceAt(f.from.x,f.from.y),S=q(A,f.to.x,f.to.y),B=Q(n,f);if(B!==n){y(B),s(N=>{const F=N.length-1,le={...N[F],black:S};return[...N.slice(0,F),le]});const O=C(B,!0);O&&p(O)}else p("Game over: AI resigns")}else p("Game over: AI resigns");v(!0)},500);return}const u=m.getPieceAt(t,e);u&&u.white===Z?P(u):P(null)},C=(t,e)=>{let i=[];return t.pieces.forEach(u=>{u.white===e&&(i=i.concat(G(u,t)))}),i.length===0?L(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},L=(t,e)=>{const i=t.pieces.find(n=>n.constructor.type==="king"&&n.white===e);if(!i)return!1;let u=[];t.pieces.forEach(n=>{n.white!==e&&(u=u.concat(n.generateMoves(t)))});const c=u.some(n=>n.x===i.matrixPosition.x&&n.y===i.matrixPosition.y);return c&&console.log(`King (${i.white?"White":"Black"}) is in check`),c},ce=d?G(d,m):[];return h.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[h.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((i,u)=>h.jsxs("div",{className:`square ${(e+u)%2===0?"light":"dark"}`,onClick:()=>ae(u,e),style:{position:"relative"},children:[V(u,e,ce)&&h.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),m.pieces.map((c,n)=>{if(c&&c.matrixPosition.x===u&&c.matrixPosition.y===e){const w=c.constructor.type==="king"&&L(m,c.white),g=ne(c);return h.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:d===c?"2px solid yellow":"none",borderRadius:"50%"},children:[w&&h.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),c.white&&g?h.jsx("img",{src:g,alt:c.constructor.name,style:{width:"100%",height:"100%"}}):c.render()]},n)}return null})]},`square-${e}-${u}`)))}),R&&h.jsx("div",{className:"promotion-modal",style:{position:"absolute",backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:h.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=t.toLowerCase(),i=o&&o[e]?M[o[e].replace("images/","").replace(".png","")]:be[t];return h.jsx("img",{src:i,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>re(t)},t)})})}),k&&h.jsx("div",{className:"modal",children:h.jsxs("div",{className:"modal-content",children:[h.jsx("h2",{children:k}),h.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:h.jsx("button",{onClick:ie,children:"Restart"})})]})})]})},Ce=x.forwardRef(Ae);export{Ce as default};
