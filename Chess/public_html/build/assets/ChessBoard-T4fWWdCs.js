import{r as g,j as c,a as ne}from"./app-_jjegrsK.js";import{W as oe,a as ie,b as re,c as ae,d as Q,r as z,R as B,K as L,Q as le,e as ce,B as ue}from"./PC-CMCXMuQY.js";import{B as me,a as he,b as de,c as ge,d as fe,e as xe}from"./BlueKing-BUktslDH.js";class _{constructor(o){this.pieces=o}getPieceAt(o,s){return this.pieces.find(i=>i.matrixPosition.x===o&&i.matrixPosition.y===s)}move(o,s){const i=this.getPieceAt(o.x,o.y);if(!i){console.error("No piece found at the source position:",o);return}const d=this.getPieceAt(s.x,s.y);d&&d.white!==i.white&&(this.pieces=this.pieces.filter(p=>p!==d)),i.move(s.x,s.y)}clone(){const o=this.pieces.map(s=>s.clone());return new _(o)}}const q={"images/blue_pawn.png":me,"images/blue_rook.png":he,"images/blue_knight.png":de,"images/blue_bishop.png":ge,"images/blue_queen.png":fe,"images/blue_king.png":xe},we={Queen:oe,Rook:ie,Bishop:re,Knight:ae},F=()=>{const r=[new B(0,0,!1),new L(4,0,!1),new B(7,0,!1),new B(0,7,!0),new L(4,7,!0),new B(7,7,!0)];return new _(r)},be=(r,o)=>{const{x:s,y:i}=r.matrixPosition;switch(o.toLowerCase()){case"rook":return new B(s,i,r.white);case"bishop":return new ue(s,i,r.white);case"knight":return new ce(s,i,r.white);default:return new le(s,i,r.white)}},N=(r,o)=>r.generateMoves(o).filter(s=>Q(o,{from:r.matrixPosition,to:s})!==o),H=(r,o,s)=>s.some(i=>i.x===r&&i.y===o),pe=(r,o)=>{const s=String.fromCharCode(97+r),i=8-o;return s+i},G=(r,o,s)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[r.constructor.name]||"")+pe(o,s),ve=({moveHistory:r,setMoveHistory:o,equippedSkinsMapping:s={}},i)=>{const[d,p]=g.useState(F()),[w,P]=g.useState(null),[O,k]=g.useState(!0),[b,f]=g.useState(null),[J,W]=g.useState(0),[U,$]=g.useState(!1),[A,D]=g.useState(null),M=g.useRef(null),R=g.useRef(null),V=()=>{f("Black wins by resignation")};g.useImperativeHandle(i,()=>({retireGame:V}));const X=()=>{let n="Win";b&&b.includes("Black wins")?n="Lose":b&&b.includes("Draw")&&(n="Draw"),ne.post("/game/result",{moves:r.map(e=>`${e.white} ${e.black}`).join(" | "),time:J,side:"White",result:n}).then(()=>{$(!0)}).catch(()=>{})},Y=()=>{b&&!U&&X(),p(F()),P(null),k(!0),f(null),o([]),M.current=null,R.current=null,W(0),$(!1)},Z=n=>{if(!A)return;const{board:e,pawn:u}=A,a=be(u,n);e.pieces=e.pieces.map(l=>l===u?a:l),p(e),D(null),P(null);const t=I(e,!1);if(t){f(t);return}k(!1),setTimeout(()=>{const x=z(e,3,!1).move;if(x){const j=e.getPieceAt(x.from.x,x.from.y),m=G(j,x.to.x,x.to.y),h=Q(e,x);if(h!==e){p(h),o(y=>{const v=y.length-1,K={...y[v],black:m};return[...y.slice(0,v),K]});const C=I(h,!0);C&&f(C)}else f("Game over: AI resigns")}else f("Game over: AI resigns");k(!0)},500)},ee=(n,e)=>{if(b||A)return;const u=w?N(w,d):[];if(w&&H(n,e,u)){const t=Date.now();if(!M.current)M.current=t,R.current=t;else{const m=t-R.current;W(h=>h+m),R.current=t}const l=d.clone(),x=G(w,n,e);if(o(m=>[...m,{white:x,black:""}]),l.move(w.matrixPosition,{x:n,y:e}),w.constructor.name==="Pawn"){const m=l.getPieceAt(n,e);if(m.white&&m.matrixPosition.y===0||!m.white&&m.matrixPosition.y===7){D({board:l,pawn:m});return}}p(l),P(null);const j=I(l,!1);if(j){f(j);return}k(!1),setTimeout(()=>{const h=z(l,3,!1).move;if(h){const C=l.getPieceAt(h.from.x,h.from.y),y=G(C,h.to.x,h.to.y),v=Q(l,h);if(v!==l){p(v),o(S=>{const T=S.length-1,se={...S[T],black:y};return[...S.slice(0,T),se]});const K=I(v,!0);K&&f(K)}else f("Game over: AI resigns")}else f("Game over: AI resigns");k(!0)},500);return}const a=d.getPieceAt(n,e);a&&a.white===O?P(a):P(null)},I=(n,e)=>{let u=[];return n.pieces.forEach(a=>{a.white===e&&(u=u.concat(N(a,n)))}),u.length===0?E(n,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},E=(n,e)=>{const u=n.pieces.find(t=>t.constructor.name==="King"&&t.white===e);if(!u)return!1;let a=[];return n.pieces.forEach(t=>{t.white!==e&&(a=a.concat(t.generateMoves(n)))}),a.some(t=>t.x===u.matrixPosition.x&&t.y===u.matrixPosition.y)},te=w?N(w,d):[];return c.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[c.jsx("div",{className:"chessboard",children:Array(8).fill().map((n,e)=>Array(8).fill().map((u,a)=>c.jsxs("div",{className:`square ${(e+a)%2===0?"light":"dark"}`,onClick:()=>ee(a,e),children:[H(a,e,te)&&c.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),d.pieces.map((t,l)=>{if(t&&t.matrixPosition.x===a&&t.matrixPosition.y===e){const x=t.constructor.name==="King"&&E(d,t.white);return c.jsxs("span",{className:"piece",style:{zIndex:2,border:w===t?"2px solid yellow":"none",borderRadius:"50%"},children:[x&&c.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none"}}),t.white&&s[t.constructor.name]?c.jsx("img",{src:q[s[t.constructor.name]],alt:t.constructor.name,style:{width:"100%",height:"100%"}}):t.render()]},l)}return null})]},`square-${e}-${a}`)))}),A&&c.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:c.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(n=>{const e=s&&s[n]?q[s[n]]:we[n];return c.jsx("img",{src:e,alt:n,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>Z(n)},n)})})}),b&&c.jsx("div",{className:"modal",children:c.jsxs("div",{className:"modal-content",children:[c.jsx("h2",{children:b}),c.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:c.jsx("button",{onClick:Y,children:"Restart"})})]})})]})},Be=g.forwardRef(ve);export{Be as default};
