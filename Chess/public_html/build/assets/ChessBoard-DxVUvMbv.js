import{r as x,j as m,a as le}from"./app-DHU7qw49.js";import{W as ce,a as ue,b as he,c as me,d as W,r as O,R,K as C,B as I,Q as _,e as U,P as h}from"./PC-CVx9CALN.js";import{B as fe,a as de,b as ge,c as xe,d as we,e as pe}from"./BlueKing-BUktslDH.js";class ${constructor(o){this.pieces=o}getPieceAt(o,s){return this.pieces.find(a=>a.matrixPosition.x===o&&a.matrixPosition.y===s)}move(o,s){const a=this.getPieceAt(o.x,o.y);if(!a){console.error("No piece found at the source position:",o);return}const f=this.getPieceAt(s.x,s.y);f&&f.white!==a.white&&(this.pieces=this.pieces.filter(y=>y!==f)),a.move(s.x,s.y)}clone(){const o=this.pieces.map(s=>s.clone());return new $(o)}}const J={blue_pawn:fe,blue_rook:de,blue_knight:ge,blue_bishop:xe,blue_queen:we,blue_king:pe},ye={Queen:ce,Rook:ue,Bishop:he,Knight:me},V=()=>{const r=[new R(0,0,!1),new C(1,0,!1),new I(2,0,!1),new _(3,0,!1),new U(4,0,!1),new I(5,0,!1),new C(6,0,!1),new R(7,0,!1),new h(0,1,!1),new h(1,1,!1),new h(2,1,!1),new h(3,1,!1),new h(4,1,!1),new h(5,1,!1),new h(6,1,!1),new h(7,1,!1),new h(0,6,!0),new h(1,6,!0),new h(2,6,!0),new h(3,6,!0),new h(4,6,!0),new h(5,6,!0),new h(6,6,!0),new h(7,6,!0),new R(0,7,!0),new C(1,7,!0),new I(2,7,!0),new _(3,7,!0),new U(4,7,!0),new I(5,7,!0),new C(6,7,!0),new R(7,7,!0)];return new $(r)},be=(r,o)=>{const{x:s,y:a}=r.matrixPosition;switch(o.toLowerCase()){case"rook":return new R(s,a,r.white);case"bishop":return new I(s,a,r.white);case"knight":return new C(s,a,r.white);default:return new _(s,a,r.white)}},Q=(r,o)=>r.generateMoves(o).filter(s=>W(o,{from:r.matrixPosition,to:s})!==o),X=(r,o,s)=>s.some(a=>a.x===r&&a.y===o),ke=(r,o)=>{const s=String.fromCharCode(97+r),a=8-o;return s+a},T=(r,o,s)=>{const a={Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"},f=Pe(r);return(a[f.charAt(0).toUpperCase()+f.slice(1)]||"")+ke(o,s)},Pe=r=>r.constructor.type||r.constructor.name.toLowerCase(),ve=({moveHistory:r,setMoveHistory:o,equippedSkinsMapping:s={}},a)=>{const[f,y]=x.useState(V()),[d,P]=x.useState(null),[Y,v]=x.useState(!0),[b,w]=x.useState(null),[Z,z]=x.useState(0),[ee,D]=x.useState(!1),[j,E]=x.useState(null),G=x.useRef(null),S=x.useRef(null),te=()=>{w("Black wins by resignation")};x.useImperativeHandle(a,()=>({retireGame:te}));const ne=()=>{let n="Win";b&&b.includes("Black wins")?n="Lose":b&&b.includes("Draw")&&(n="Draw"),le.post("/game/result",{moves:r.map(e=>`${e.white} ${e.black}`).join(" | "),time:Z,side:"White",result:n}).then(()=>D(!0)).catch(()=>{})},se=()=>{b&&!ee&&ne(),y(V()),P(null),v(!0),w(null),o([]),G.current=null,S.current=null,z(0),D(!1)},oe=n=>{if(console.log("Promotion choice:",n),!j)return;const{board:e,pawn:u}=j,c=be(u,n);e.pieces=e.pieces.map(t=>t===u?c:t),y(e),E(null),P(null);const i=K(e,!1);if(i){w(i);return}v(!1),setTimeout(()=>{const p=O(e,3,!1).move;if(p){const k=e.getPieceAt(p.from.x,p.from.y),N=T(k,p.to.x,p.to.y),l=W(e,p);if(l!==e){y(l),o(A=>{const M=A.length-1,B={...A[M],black:N};return[...A.slice(0,M),B]});const g=K(l,!0);g&&w(g)}else w("Game over: AI resigns")}else w("Game over: AI resigns");v(!0)},500)},ie=(n,e)=>{if(b||j)return;const u=d?Q(d,f):[];if(d&&X(n,e,u)){const i=Date.now();if(!G.current)G.current=i,S.current=i;else{const l=i-S.current;z(g=>g+l),S.current=i}const t=f.clone(),p=T(d,n,e);o(l=>[...l,{white:p,black:""}]);const k=u.find(l=>l.x===n&&l.y===e);if((k==null?void 0:k.castling)==="kingside"?(t.move(d.matrixPosition,{x:6,y:e}),t.getPieceAt(7,e)&&t.move({x:7,y:e},{x:5,y:e})):(k==null?void 0:k.castling)==="queenside"?(t.move(d.matrixPosition,{x:2,y:e}),t.getPieceAt(0,e)&&t.move({x:0,y:e},{x:3,y:e})):t.move(d.matrixPosition,{x:n,y:e}),d.constructor.type==="pawn"){const l=t.getPieceAt(n,e);if(l.white&&l.matrixPosition.y===0||!l.white&&l.matrixPosition.y===7){console.log("Pawn promotion triggered for:",l),E({board:t,pawn:l});return}}y(t),P(null);const N=K(t,!1);if(N){w(N);return}v(!1),setTimeout(()=>{const g=O(t,3,!1).move;if(g){const A=t.getPieceAt(g.from.x,g.from.y),M=T(A,g.to.x,g.to.y),B=W(t,g);if(B!==t){y(B),o(L=>{const H=L.length-1,ae={...L[H],black:M};return[...L.slice(0,H),ae]});const F=K(B,!0);F&&w(F)}else w("Game over: AI resigns")}else w("Game over: AI resigns");v(!0)},500);return}const c=f.getPieceAt(n,e);c&&c.white===Y?P(c):P(null)},K=(n,e)=>{let u=[];return n.pieces.forEach(c=>{c.white===e&&(u=u.concat(Q(c,n)))}),u.length===0?q(n,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},q=(n,e)=>{const u=n.pieces.find(t=>t.constructor.type==="king"&&t.white===e);if(!u)return!1;let c=[];n.pieces.forEach(t=>{t.white!==e&&(c=c.concat(t.generateMoves(n)))});const i=c.some(t=>t.x===u.matrixPosition.x&&t.y===u.matrixPosition.y);return i&&console.log(`King (${u.white?"White":"Black"}) is in check`),i},re=d?Q(d,f):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((n,e)=>Array(8).fill().map((u,c)=>m.jsxs("div",{className:`square ${(e+c)%2===0?"light":"dark"}`,onClick:()=>ie(c,e),style:{position:"relative"},children:[X(c,e,re)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),f.pieces.map((i,t)=>{if(i&&i.matrixPosition.x===c&&i.matrixPosition.y===e){const p=i.constructor.type==="king"&&q(f,i.white);return m.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:d===i?"2px solid yellow":"none",borderRadius:"50%"},children:[p&&m.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),i.white&&s[i.constructor.name.toLowerCase()]?m.jsx("img",{src:J[s[i.constructor.name.toLowerCase()]],alt:i.constructor.name,style:{width:"100%",height:"100%"}}):i.render()]},t)}return null})]},`square-${e}-${c}`)))}),j&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(n=>{const e=n.toLowerCase(),u=s&&s[e]?J[s[e]]:ye[n];return m.jsx("img",{src:u,alt:n,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>oe(n)},n)})})}),b&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:b}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:se,children:"Restart"})})]})})]})},Ce=x.forwardRef(ve);export{Ce as default};
