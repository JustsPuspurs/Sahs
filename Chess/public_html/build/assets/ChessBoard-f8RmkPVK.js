import{r as x,j as u,a as ae}from"./app-DmamNXO7.js";import{W as le,a as ce,b as ue,c as he,d as $,r as H,R as B,K as R,B as I,Q as D,e as O,P as c}from"./PC-C4GA6Z_c.js";import{B as me,a as de,b as ge,c as fe,d as xe,e as we}from"./BlueKing-BUktslDH.js";class E{constructor(e){this.pieces=e}getPieceAt(e,t){return this.pieces.find(i=>i.matrixPosition.x===e&&i.matrixPosition.y===t)}move(e,t){const i=this.getPieceAt(e.x,e.y);if(!i){console.error("No piece found at the source position:",e);return}const f=this.getPieceAt(t.x,t.y);if(f&&f.white!==i.white&&(this.pieces=this.pieces.filter(l=>l!==f)),i.constructor.name==="King"&&Math.abs(t.x-i.matrixPosition.x)===2)if(t.x>i.matrixPosition.x){const l=this.getPieceAt(7,e.y);if(l&&l.constructor.name==="Rook"&&!l.hasMoved&&!this.getPieceAt(5,e.y)&&!this.getPieceAt(6,e.y)){i.move(t.x,t.y),l.move(5,e.y);return}}else{const l=this.getPieceAt(0,e.y);if(l&&l.constructor.name==="Rook"&&!l.hasMoved&&!this.getPieceAt(1,e.y)&&!this.getPieceAt(2,e.y)&&!this.getPieceAt(3,e.y)){i.move(t.x,t.y),l.move(3,e.y);return}}i.move(t.x,t.y)}clone(){const e=this.pieces.map(t=>t.clone());return new E(e)}}const J={"images/blue_pawn.png":me,"images/blue_rook.png":de,"images/blue_knight.png":ge,"images/blue_bishop.png":fe,"images/blue_queen.png":xe,"images/blue_king.png":we},be={Queen:le,Rook:ce,Bishop:ue,Knight:he},U=()=>{const r=[new B(0,0,!1),new R(1,0,!1),new I(2,0,!1),new D(3,0,!1),new O(4,0,!1),new I(5,0,!1),new R(6,0,!1),new B(7,0,!1),new c(0,1,!1),new c(1,1,!1),new c(2,1,!1),new c(3,1,!1),new c(4,1,!1),new c(5,1,!1),new c(6,1,!1),new c(7,1,!1),new c(0,6,!0),new c(1,6,!0),new c(2,6,!0),new c(3,6,!0),new c(4,6,!0),new c(5,6,!0),new c(6,6,!0),new c(7,6,!0),new B(0,7,!0),new R(1,7,!0),new I(2,7,!0),new D(3,7,!0),new O(4,7,!0),new I(5,7,!0),new R(6,7,!0),new B(7,7,!0)];return new E(r)},ve=(r,e)=>{const{x:t,y:i}=r.matrixPosition;switch(e.toLowerCase()){case"rook":return new B(t,i,r.white);case"bishop":return new I(t,i,r.white);case"knight":return new R(t,i,r.white);default:return new D(t,i,r.white)}},_=(r,e)=>r.generateMoves(e).filter(t=>$(e,{from:r.matrixPosition,to:t})!==e),V=(r,e,t)=>t.some(i=>i.x===r&&i.y===e),Pe=(r,e)=>{const t=String.fromCharCode(97+r),i=8-e;return t+i},W=(r,e,t)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[r.constructor.name]||"")+Pe(e,t),pe=({moveHistory:r,setMoveHistory:e,equippedSkinsMapping:t={}},i)=>{const[f,l]=x.useState(U()),[v,y]=x.useState(null),[X,k]=x.useState(!0),[P,w]=x.useState(null),[Y,T]=x.useState(0),[Z,z]=x.useState(!1),[j,L]=x.useState(null),G=x.useRef(null),C=x.useRef(null),ee=()=>{w("Black wins by resignation")};x.useImperativeHandle(i,()=>({retireGame:ee}));const te=()=>{let o="Win";P&&P.includes("Black wins")?o="Lose":P&&P.includes("Draw")&&(o="Draw"),ae.post("/game/result",{moves:r.map(n=>`${n.white} ${n.black}`).join(" | "),time:Y,side:"White",result:o}).then(()=>{z(!0)}).catch(()=>{})},ne=()=>{P&&!Z&&te(),l(U()),y(null),k(!0),w(null),e([]),G.current=null,C.current=null,T(0),z(!1)},se=o=>{if(!j)return;const{board:n,pawn:m}=j,a=ve(m,o);n.pieces=n.pieces.map(h=>h===m?a:h),l(n),L(null),y(null);const s=M(n,!1);if(s){w(s);return}k(!1),setTimeout(()=>{const b=H(n,3,!1).move;if(b){const K=n.getPieceAt(b.from.x,b.from.y),d=W(K,b.to.x,b.to.y),g=$(n,b);if(g!==n){l(g),e(A=>{const p=A.length-1,N={...A[p],black:d};return[...A.slice(0,p),N]});const S=M(g,!0);S&&w(S)}else w("Game over: AI resigns")}else w("Game over: AI resigns");k(!0)},500)},oe=(o,n)=>{if(P||j)return;const m=v?_(v,f):[];if(v&&V(o,n,m)){const s=Date.now();if(!G.current)G.current=s,C.current=s;else{const d=s-C.current;T(g=>g+d),C.current=s}const h=f.clone(),b=W(v,o,n);if(e(d=>[...d,{white:b,black:""}]),v.constructor.name==="Pawn"){const d=h.getPieceAt(o,n);if(d.white&&d.matrixPosition.y===0||!d.white&&d.matrixPosition.y===7){L({board:h,pawn:d});return}}l(h),y(null);const K=M(h,!1);if(K){w(K);return}k(!1),setTimeout(()=>{const g=H(h,3,!1).move;if(g){const S=h.getPieceAt(g.from.x,g.from.y),A=W(S,g.to.x,g.to.y),p=$(h,g);if(p!==h){l(p),e(Q=>{const F=Q.length-1,re={...Q[F],black:A};return[...Q.slice(0,F),re]});const N=M(p,!0);N&&w(N)}else w("Game over: AI resigns")}else w("Game over: AI resigns");k(!0)},500);return}const a=f.getPieceAt(o,n);a&&a.white===X?y(a):y(null)},M=(o,n)=>{let m=[];return o.pieces.forEach(a=>{a.white===n&&(m=m.concat(_(a,o)))}),m.length===0?q(o,n)?n?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},q=(o,n)=>{const m=o.pieces.find(s=>s.constructor.name==="King"&&s.white===n);if(!m)return!1;let a=[];return o.pieces.forEach(s=>{s.white!==n&&(a=a.concat(s.generateMoves(o)))}),a.some(s=>s.x===m.matrixPosition.x&&s.y===m.matrixPosition.y)},ie=v?_(v,f):[];return u.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[u.jsx("div",{className:"chessboard",children:Array(8).fill().map((o,n)=>Array(8).fill().map((m,a)=>u.jsxs("div",{className:`square ${(n+a)%2===0?"light":"dark"}`,onClick:()=>oe(a,n),children:[V(a,n,ie)&&u.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),f.pieces.map((s,h)=>{if(s&&s.matrixPosition.x===a&&s.matrixPosition.y===n){const b=s.constructor.name==="King"&&q(f,s.white);return u.jsxs("span",{className:"piece",style:{zIndex:2,border:v===s?"2px solid yellow":"none",borderRadius:"50%"},children:[b&&u.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none"}}),s.white&&t[s.constructor.name]?u.jsx("img",{src:J[t[s.constructor.name]],alt:s.constructor.name,style:{width:"100%",height:"100%"}}):s.render()]},h)}return null})]},`square-${n}-${a}`)))}),j&&u.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:u.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(o=>{const n=t&&t[o]?J[t[o]]:be[o];return u.jsx("img",{src:n,alt:o,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>se(o)},o)})})}),P&&u.jsx("div",{className:"modal",children:u.jsxs("div",{className:"modal-content",children:[u.jsx("h2",{children:P}),u.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:u.jsx("button",{onClick:ne,children:"Restart"})})]})})]})},Be=x.forwardRef(pe);export{Be as default};
