import{r as w,j as h,a as ce}from"./app-hW5JQbHK.js";import{W as le,a as ue,b as me,c as he,d as $,r as O,R as B,K as I,B as j,Q as D,e as J,P as m}from"./PC-DZl30_yw.js";import{B as de,a as fe,b as ge,c as xe,d as we,e as Pe}from"./BlueKing-BUktslDH.js";class E{constructor(t){this.pieces=t}getPieceAt(t,n){return this.pieces.find(i=>i.matrixPosition.x===t&&i.matrixPosition.y===n)}move(t,n){const i=this.getPieceAt(t.x,t.y);if(!i){console.error("No piece found at the source position:",t);return}const g=this.getPieceAt(n.x,n.y);if(g&&g.white!==i.white&&(this.pieces=this.pieces.filter(c=>c!==g)),i.constructor.name==="King"&&Math.abs(t.x-n.x)===2){if(n.x===6){const c=this.getPieceAt(7,t.y);c&&c.constructor.name==="Rook"&&(c.matrixPosition.x=5,c.matrixPosition.y=t.y,c.hasMoved=!0)}else if(n.x===2){const c=this.getPieceAt(0,t.y);c&&c.constructor.name==="Rook"&&(c.matrixPosition.x=3,c.matrixPosition.y=t.y,c.hasMoved=!0)}}i.matrixPosition.x=n.x,i.matrixPosition.y=n.y,i.hasMoved=!0}clone(){const t=this.pieces.map(n=>n.clone());return new E(t)}}const U={"images/blue_pawn.png":de,"images/blue_rook.png":fe,"images/blue_knight.png":ge,"images/blue_bishop.png":xe,"images/blue_queen.png":we,"images/blue_king.png":Pe},be={Queen:le,Rook:ue,Bishop:me,Knight:he},V=()=>{const l=[new B(0,0,!1),new I(1,0,!1),new j(2,0,!1),new D(3,0,!1),new J(4,0,!1),new j(5,0,!1),new I(6,0,!1),new B(7,0,!1),new m(0,1,!1),new m(1,1,!1),new m(2,1,!1),new m(3,1,!1),new m(4,1,!1),new m(5,1,!1),new m(6,1,!1),new m(7,1,!1),new m(0,6,!0),new m(1,6,!0),new m(2,6,!0),new m(3,6,!0),new m(4,6,!0),new m(5,6,!0),new m(6,6,!0),new m(7,6,!0),new B(0,7,!0),new I(1,7,!0),new j(2,7,!0),new D(3,7,!0),new J(4,7,!0),new j(5,7,!0),new I(6,7,!0),new B(7,7,!0)];return new E(l)},ve=(l,t)=>{const{x:n,y:i}=l.matrixPosition;switch(t.toLowerCase()){case"rook":return new B(n,i,l.white);case"bishop":return new j(n,i,l.white);case"knight":return new I(n,i,l.white);default:return new D(n,i,l.white)}},_=(l,t)=>l.generateMoves(t).filter(n=>$(t,{from:l.matrixPosition,to:n})!==t),X=(l,t,n)=>n.some(i=>i.x===l&&i.y===t),pe=(l,t)=>{const n=String.fromCharCode(97+l),i=8-t;return n+i},W=(l,t,n)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[l.constructor.name]||"")+pe(t,n),ye=({moveHistory:l,setMoveHistory:t,equippedSkinsMapping:n={}},i)=>{const[g,c]=w.useState(V()),[f,y]=w.useState(null),[Y,k]=w.useState(!0),[v,P]=w.useState(null),[Z,T]=w.useState(0),[ee,z]=w.useState(!1),[C,q]=w.useState(null),G=w.useRef(null),M=w.useRef(null),te=()=>{P("Black wins by resignation")};w.useImperativeHandle(i,()=>({retireGame:te}));const ne=()=>{let s="Win";v&&v.includes("Black wins")?s="Lose":v&&v.includes("Draw")&&(s="Draw"),ce.post("/game/result",{moves:l.map(e=>`${e.white} ${e.black}`).join(" | "),time:Z,side:"White",result:s}).then(()=>{z(!0)}).catch(()=>{})},se=()=>{v&&!ee&&ne(),c(V()),y(null),k(!0),P(null),t([]),G.current=null,M.current=null,T(0),z(!1)},oe=s=>{if(!C)return;const{board:e,pawn:d}=C,u=ve(d,s);e.pieces=e.pieces.map(a=>a===d?u:a),c(e),q(null),y(null);const o=K(e,!1);if(o){P(o);return}k(!1),setTimeout(()=>{const b=O(e,3,!1).move;if(b){const p=e.getPieceAt(b.from.x,b.from.y),S=W(p,b.to.x,b.to.y),r=$(e,b);if(r!==e){c(r),t(A=>{const N=A.length-1,R={...A[N],black:S};return[...A.slice(0,N),R]});const x=K(r,!0);x&&P(x)}else P("Game over: AI resigns")}else P("Game over: AI resigns");k(!0)},500)},ie=(s,e)=>{if(v||C)return;const d=f?_(f,g):[];if(f&&X(s,e,d)){const o=Date.now();if(!G.current)G.current=o,M.current=o;else{const r=o-M.current;T(x=>x+r),M.current=o}const a=g.clone(),b=W(f,s,e);t(r=>[...r,{white:b,black:""}]);const p=d.find(r=>r.x===s&&r.y===e);if(f.constructor.name==="King"&&p&&p.castling){if(p.castling==="kingside"){a.move(f.matrixPosition,{x:6,y:e});const r=a.getPieceAt(7,e);r&&r.constructor.name==="Rook"&&a.move({x:7,y:e},{x:5,y:e})}else if(p.castling==="queenside"){a.move(f.matrixPosition,{x:2,y:e});const r=a.getPieceAt(0,e);r&&r.constructor.name==="Rook"&&a.move({x:0,y:e},{x:3,y:e})}}else a.move(f.matrixPosition,{x:s,y:e});if(f.constructor.name==="Pawn"){const r=a.getPieceAt(s,e);if(r.white&&r.matrixPosition.y===0||!r.white&&r.matrixPosition.y===7){q({board:a,pawn:r});return}}c(a),y(null);const S=K(a,!1);if(S){P(S);return}k(!1),setTimeout(()=>{const x=O(a,3,!1).move;if(x){const A=a.getPieceAt(x.from.x,x.from.y),N=W(A,x.to.x,x.to.y),R=$(a,x);if(R!==a){c(R),t(Q=>{const H=Q.length-1,ae={...Q[H],black:N};return[...Q.slice(0,H),ae]});const F=K(R,!0);F&&P(F)}else P("Game over: AI resigns")}else P("Game over: AI resigns");k(!0)},500);return}const u=g.getPieceAt(s,e);u&&u.white===Y?y(u):y(null)},K=(s,e)=>{let d=[];return s.pieces.forEach(u=>{u.white===e&&(d=d.concat(_(u,s)))}),d.length===0?L(s,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},L=(s,e)=>{const d=s.pieces.find(o=>o.constructor.name==="King"&&o.white===e);if(!d)return!1;let u=[];return s.pieces.forEach(o=>{o.white!==e&&(u=u.concat(o.generateMoves(s)))}),u.some(o=>o.x===d.matrixPosition.x&&o.y===d.matrixPosition.y)},re=f?_(f,g):[];return h.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[h.jsx("div",{className:"chessboard",children:Array(8).fill().map((s,e)=>Array(8).fill().map((d,u)=>h.jsxs("div",{className:`square ${(e+u)%2===0?"light":"dark"}`,onClick:()=>ie(u,e),children:[X(u,e,re)&&h.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),g.pieces.map((o,a)=>{if(o&&o.matrixPosition.x===u&&o.matrixPosition.y===e){const b=o.constructor.name==="King"&&L(g,o.white);return h.jsxs("span",{className:"piece",style:{zIndex:2,border:f===o?"2px solid yellow":"none",borderRadius:"50%"},children:[b&&h.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none"}}),o.white&&n[o.constructor.name]?h.jsx("img",{src:U[n[o.constructor.name]],alt:o.constructor.name,style:{width:"100%",height:"100%"}}):o.render()]},a)}return null})]},`square-${e}-${u}`)))}),C&&h.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:h.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(s=>{const e=n&&n[s]?U[n[s]]:be[s];return h.jsx("img",{src:e,alt:s,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>oe(s)},s)})})}),v&&h.jsx("div",{className:"modal",children:h.jsxs("div",{className:"modal-content",children:[h.jsx("h2",{children:v}),h.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:h.jsx("button",{onClick:se,children:"Restart"})})]})})]})},Be=w.forwardRef(ye);export{Be as default};
