import{r as P,j as f,a as ce}from"./app-RkvOmYKx.js";import{W as le,a as ue,b as me,c as he,d as $,r as H,R,K as I,B as j,Q as D,e as J,P as m}from"./PC-BIj-yV_i.js";import{B as fe,a as ge,b as de,c as xe,d as we,e as Pe}from"./BlueKing-BUktslDH.js";class E{constructor(o){this.pieces=o}getPieceAt(o,t){return this.pieces.find(i=>i.matrixPosition.x===o&&i.matrixPosition.y===t)}move(o,t){const i=this.getPieceAt(o.x,o.y);if(!i){console.error("No piece found at the source position:",o);return}const d=this.getPieceAt(t.x,t.y);if(d&&d.white!==i.white&&(this.pieces=this.pieces.filter(h=>h!==d)),i.constructor.name==="King"&&Math.abs(t.x-i.matrixPosition.x)===2){const h=o.y;if(t.x>i.matrixPosition.x){const r=this.getPieceAt(7,h);if(r&&r.constructor.name==="Rook"&&!r.hasMoved&&!this.getPieceAt(5,h)&&!this.getPieceAt(6,h)){const x={...i.matrixPosition};i.move(r.matrixPosition.x,r.matrixPosition.y),r.move(x.x,x.y);return}}else{const r=this.getPieceAt(0,h);if(r&&r.constructor.name==="Rook"&&!r.hasMoved&&!this.getPieceAt(1,h)&&!this.getPieceAt(2,h)&&!this.getPieceAt(3,h)){const x={...i.matrixPosition};i.move(r.matrixPosition.x,r.matrixPosition.y),r.move(x.x,x.y);return}}}i.move(t.x,t.y)}clone(){const o=this.pieces.map(t=>t.clone());return new E(o)}}const U={"images/blue_pawn.png":fe,"images/blue_rook.png":ge,"images/blue_knight.png":de,"images/blue_bishop.png":xe,"images/blue_queen.png":we,"images/blue_king.png":Pe},ve={Queen:le,Rook:ue,Bishop:me,Knight:he},V=()=>{const l=[new R(0,0,!1),new I(1,0,!1),new j(2,0,!1),new D(3,0,!1),new J(4,0,!1),new j(5,0,!1),new I(6,0,!1),new R(7,0,!1),new m(0,1,!1),new m(1,1,!1),new m(2,1,!1),new m(3,1,!1),new m(4,1,!1),new m(5,1,!1),new m(6,1,!1),new m(7,1,!1),new m(0,6,!0),new m(1,6,!0),new m(2,6,!0),new m(3,6,!0),new m(4,6,!0),new m(5,6,!0),new m(6,6,!0),new m(7,6,!0),new R(0,7,!0),new I(1,7,!0),new j(2,7,!0),new D(3,7,!0),new J(4,7,!0),new j(5,7,!0),new I(6,7,!0),new R(7,7,!0)];return new E(l)},be=(l,o)=>{const{x:t,y:i}=l.matrixPosition;switch(o.toLowerCase()){case"rook":return new R(t,i,l.white);case"bishop":return new j(t,i,l.white);case"knight":return new I(t,i,l.white);default:return new D(t,i,l.white)}},_=(l,o)=>l.generateMoves(o).filter(t=>$(o,{from:l.matrixPosition,to:t})!==o),X=(l,o,t)=>t.some(i=>i.x===l&&i.y===o),pe=(l,o)=>{const t=String.fromCharCode(97+l),i=8-o;return t+i},W=(l,o,t)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[l.constructor.name]||"")+pe(o,t),ke=({moveHistory:l,setMoveHistory:o,equippedSkinsMapping:t={}},i)=>{const[d,h]=P.useState(V()),[r,x]=P.useState(null),[Y,y]=P.useState(!0),[p,v]=P.useState(null),[Z,T]=P.useState(0),[ee,z]=P.useState(!1),[C,q]=P.useState(null),G=P.useRef(null),M=P.useRef(null),te=()=>{v("Black wins by resignation")};P.useImperativeHandle(i,()=>({retireGame:te}));const ne=()=>{let n="Win";p&&p.includes("Black wins")?n="Lose":p&&p.includes("Draw")&&(n="Draw"),ce.post("/game/result",{moves:l.map(e=>`${e.white} ${e.black}`).join(" | "),time:Z,side:"White",result:n}).then(()=>{z(!0)}).catch(()=>{})},se=()=>{p&&!ee&&ne(),h(V()),x(null),y(!0),v(null),o([]),G.current=null,M.current=null,T(0),z(!1)},oe=n=>{if(!C)return;const{board:e,pawn:g}=C,u=be(g,n);e.pieces=e.pieces.map(a=>a===g?u:a),h(e),q(null),x(null);const s=K(e,!1);if(s){v(s);return}y(!1),setTimeout(()=>{const b=H(e,3,!1).move;if(b){const k=e.getPieceAt(b.from.x,b.from.y),S=W(k,b.to.x,b.to.y),c=$(e,b);if(c!==e){h(c),o(A=>{const N=A.length-1,B={...A[N],black:S};return[...A.slice(0,N),B]});const w=K(c,!0);w&&v(w)}else v("Game over: AI resigns")}else v("Game over: AI resigns");y(!0)},500)},ie=(n,e)=>{if(p||C)return;const g=r?_(r,d):[];if(r&&X(n,e,g)){const s=Date.now();if(!G.current)G.current=s,M.current=s;else{const c=s-M.current;T(w=>w+c),M.current=s}const a=d.clone(),b=W(r,n,e);o(c=>[...c,{white:b,black:""}]);const k=g.find(c=>c.x===n&&c.y===e);if(r.constructor.name==="King"&&k&&k.castling?k.castling==="kingside"?(a.move(r.matrixPosition,{x:6,y:e}),a.getPieceAt(7,e)&&a.move({x:7,y:e},{x:6,y:e})):k.castling==="queenside"&&(a.move(r.matrixPosition,{x:1,y:e}),a.getPieceAt(0,e)&&a.move({x:0,y:e},{x:2,y:e})):a.move(r.matrixPosition,{x:n,y:e}),r.constructor.name==="Pawn"){const c=a.getPieceAt(n,e);if(c.white&&c.matrixPosition.y===0||!c.white&&c.matrixPosition.y===7){q({board:a,pawn:c});return}}h(a),x(null);const S=K(a,!1);if(S){v(S);return}y(!1),setTimeout(()=>{const w=H(a,3,!1).move;if(w){const A=a.getPieceAt(w.from.x,w.from.y),N=W(A,w.to.x,w.to.y),B=$(a,w);if(B!==a){h(B),o(Q=>{const F=Q.length-1,ae={...Q[F],black:N};return[...Q.slice(0,F),ae]});const O=K(B,!0);O&&v(O)}else v("Game over: AI resigns")}else v("Game over: AI resigns");y(!0)},500);return}const u=d.getPieceAt(n,e);u&&u.white===Y?x(u):x(null)},K=(n,e)=>{let g=[];return n.pieces.forEach(u=>{u.white===e&&(g=g.concat(_(u,n)))}),g.length===0?L(n,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},L=(n,e)=>{const g=n.pieces.find(s=>s.constructor.name==="King"&&s.white===e);if(!g)return!1;let u=[];return n.pieces.forEach(s=>{s.white!==e&&(u=u.concat(s.generateMoves(n)))}),u.some(s=>s.x===g.matrixPosition.x&&s.y===g.matrixPosition.y)},re=r?_(r,d):[];return f.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[f.jsx("div",{className:"chessboard",children:Array(8).fill().map((n,e)=>Array(8).fill().map((g,u)=>f.jsxs("div",{className:`square ${(e+u)%2===0?"light":"dark"}`,onClick:()=>ie(u,e),children:[X(u,e,re)&&f.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),d.pieces.map((s,a)=>{if(s&&s.matrixPosition.x===u&&s.matrixPosition.y===e){const b=s.constructor.name==="King"&&L(d,s.white);return f.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:r===s?"2px solid yellow":"none",borderRadius:"50%"},children:[b&&f.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",top:"-5px",left:"-5px"}}),s.white&&t[s.constructor.name]?f.jsx("img",{src:U[t[s.constructor.name]],alt:s.constructor.name,style:{width:"100%",height:"100%"}}):s.render()]},a)}return null})]},`square-${e}-${u}`)))}),C&&f.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:f.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(n=>{const e=t&&t[n]?U[t[n]]:ve[n];return f.jsx("img",{src:e,alt:n,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>oe(n)},n)})})}),p&&f.jsx("div",{className:"modal",children:f.jsxs("div",{className:"modal-content",children:[f.jsx("h2",{children:p}),f.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:f.jsx("button",{onClick:se,children:"Restart"})})]})})]})},Re=P.forwardRef(ke);export{Re as default};
