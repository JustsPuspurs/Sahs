import{r as g,j as u,a as ie}from"./app-BGr_wcTE.js";import{B as le,a as ce,b as ue,c as me,d as de,e as fe,f as he}from"./BlueKing-CbVvptcU.js";import{W as ge,a as xe,b as we,c as be,d as $,r as H,R,K as A,B as I,Q as z,e as O,P as c}from"./PC-C-jzJApB.js";const J={"images/blue_pawn.png":le,"images/blue_rook.png":ce,"images/blue_knight.png":ue,"images/blue_bishop.png":me,"images/blue_queen.png":de,"images/blue_king.png":fe},ve={Queen:ge,Rook:xe,Bishop:we,Knight:be},U=()=>{const r=[new R(0,0,!1),new A(1,0,!1),new I(2,0,!1),new z(3,0,!1),new O(4,0,!1),new I(5,0,!1),new A(6,0,!1),new R(7,0,!1),new c(0,1,!1),new c(1,1,!1),new c(2,1,!1),new c(3,1,!1),new c(4,1,!1),new c(5,1,!1),new c(6,1,!1),new c(7,1,!1),new c(0,6,!0),new c(1,6,!0),new c(2,6,!0),new c(3,6,!0),new c(4,6,!0),new c(5,6,!0),new c(6,6,!0),new c(7,6,!0),new R(0,7,!0),new A(1,7,!0),new I(2,7,!0),new z(3,7,!0),new O(4,7,!0),new I(5,7,!0),new A(6,7,!0),new R(7,7,!0)];return new he(r)},ke=(r,l)=>{const{x:a,y:d}=r.matrixPosition;switch(l.toLowerCase()){case"Rook":return new R(a,d,r.white);case"Bishop":return new I(a,d,r.white);case"Knight":return new A(a,d,r.white);default:return new z(a,d,r.white)}},Q=(r,l)=>r.generateMoves(l).filter(a=>$(l,{from:r.matrixPosition,to:a})!==l),V=(r,l,a)=>a.some(d=>d.x===r&&d.y===l),pe=(r,l)=>{const a=String.fromCharCode(97+r),d=8-l;return a+d},W=(r,l,a)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[r.constructor.name]||"")+pe(l,a),Pe=({moveHistory:r,setMoveHistory:l,equippedSkinsMapping:a={}},d)=>{const[v,k]=g.useState(U()),[f,p]=g.useState(null),[X,P]=g.useState(!0),[b,x]=g.useState(null),[Y,D]=g.useState(0),[Z,E]=g.useState(!1),[C,L]=g.useState(null),G=g.useRef(null),j=g.useRef(null),ee=()=>{x("Black wins by resignation")};g.useImperativeHandle(d,()=>({retireGame:ee}));const te=()=>{let t="Win";b&&b.includes("Black wins")?t="Lose":b&&b.includes("Draw")&&(t="Draw"),ie.post("/game/result",{moves:r.map(e=>`${e.white} ${e.black}`).join(" | "),time:Y,side:"White",result:t}).then(()=>{E(!0)}).catch(()=>{})},ne=()=>{b&&!Z&&te(),k(U()),p(null),P(!0),x(null),l([]),G.current=null,j.current=null,D(0),E(!1)},se=t=>{if(!C)return;const{board:e,pawn:m}=C,i=ke(m,t);e.pieces=e.pieces.map(s=>s===m?i:s),k(e),L(null),p(null);const n=K(e,!1);if(n){x(n);return}P(!1),setTimeout(()=>{const w=H(e,3,!1).move;if(w){const M=e.getPieceAt(w.from.x,w.from.y),S=W(M,w.to.x,w.to.y),o=$(e,w);if(o!==e){k(o),l(y=>{const N=y.length-1,B={...y[N],black:S};return[...y.slice(0,N),B]});const h=K(o,!0);h&&x(h)}else x("Game over: AI resigns")}else x("Game over: AI resigns");P(!0)},500)},oe=(t,e)=>{if(b||C)return;const m=f?Q(f,v):[];if(f&&V(t,e,m)){const n=Date.now();if(!G.current)G.current=n,j.current=n;else{const o=n-j.current;D(h=>h+o),j.current=n}const s=v.clone(),w=W(f,t,e);l(o=>[...o,{white:w,black:""}]);const M=m.find(o=>o.x===t&&o.y===e);if(M.castling==="kingside"?(s.move(f.matrixPosition,{x:6,y:e}),s.getPieceAt(7,e)&&s.move({x:7,y:e},{x:5,y:e})):M.castling==="queenside"?(s.move(f.matrixPosition,{x:2,y:e}),s.getPieceAt(0,e)&&s.move({x:0,y:e},{x:3,y:e})):s.move(f.matrixPosition,{x:t,y:e}),f.constructor.name==="Pawn"){const o=s.getPieceAt(t,e);if(o.white&&o.matrixPosition.y===0||!o.white&&o.matrixPosition.y===7){L({board:s,pawn:o});return}}k(s),p(null);const S=K(s,!1);if(S){x(S);return}P(!1),setTimeout(()=>{const h=H(s,3,!1).move;if(h){const y=s.getPieceAt(h.from.x,h.from.y),N=W(y,h.to.x,h.to.y),B=$(s,h);if(B!==s){k(B),l(_=>{const F=_.length-1,ae={..._[F],black:N};return[..._.slice(0,F),ae]});const q=K(B,!0);q&&x(q)}else x("Game over: AI resigns")}else x("Game over: AI resigns");P(!0)},500);return}const i=v.getPieceAt(t,e);i&&i.white===X?p(i):p(null)},K=(t,e)=>{let m=[];return t.pieces.forEach(i=>{i.white===e&&(m=m.concat(Q(i,t)))}),m.length===0?T(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},T=(t,e)=>{const m=t.pieces.find(n=>n.constructor.name==="King"&&n.white===e);if(!m)return!1;let i=[];return t.pieces.forEach(n=>{n.white!==e&&(i=i.concat(n.generateMoves(t)))}),i.some(n=>n.x===m.matrixPosition.x&&n.y===m.matrixPosition.y)},re=f?Q(f,v):[];return u.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[u.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((m,i)=>u.jsxs("div",{className:`square ${(e+i)%2===0?"light":"dark"}`,onClick:()=>oe(i,e),children:[V(i,e,re)&&u.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),v.pieces.map((n,s)=>{if(n&&n.matrixPosition.x===i&&n.matrixPosition.y===e){const w=n.constructor.name==="King"&&T(v,n.white);return u.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:f===n?"2px solid yellow":"none",borderRadius:"50%"},children:[w&&u.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),n.white&&a[n.constructor.name.toLowerCase()]?u.jsx("img",{src:J[a[n.constructor.name.toLowerCase()]],alt:n.constructor.name,style:{width:"100%",height:"100%"}}):n.render()]},s)}return null})]},`square-${e}-${i}`)))}),C&&u.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:u.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=a&&a[t]?J[a[t]]:ve[t];return u.jsx("img",{src:e,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>se(t)},t)})})}),b&&u.jsx("div",{className:"modal",children:u.jsxs("div",{className:"modal-content",children:[u.jsx("h2",{children:b}),u.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:u.jsx("button",{onClick:ne,children:"Restart"})})]})})]})},Ae=g.forwardRef(Pe);export{Ae as default};
