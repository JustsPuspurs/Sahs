import{r as f,j as h,a as ne}from"./app-BtD58myP.js";import{W as oe,a as ie,b as re,c as ae,K as ce,R as H,d as G,r as z,Q as le,e as ue,B as me}from"./PC-D7AeDIgx.js";import{B as he,a as de,b as ge,c as xe,d as fe,e as be}from"./BlueKing-BUktslDH.js";class Q{constructor(s){this.pieces=s}getPieceAt(s,t){return this.pieces.find(i=>i.matrixPosition.x===s&&i.matrixPosition.y===t)}move(s,t){const i=this.getPieceAt(s.x,s.y);if(!i){console.error("No piece found at:",s);return}const g=this.getPieceAt(t.x,t.y);if(g&&g.white!==i.white&&(this.pieces=this.pieces.filter(u=>u!==g)),i.constructor.name==="King"&&Math.abs(s.x-t.x)===2){if(t.x===6){const u=this.getPieceAt(7,s.y);u&&(u.matrixPosition.x=5,u.hasMoved=!0)}else if(t.x===2){const u=this.getPieceAt(0,s.y);u&&(u.matrixPosition.x=3,u.hasMoved=!0)}}i.matrixPosition.x=t.x,i.matrixPosition.y=t.y,i.hasMoved=!0}clone(){const s=this.pieces.map(t=>t.clone());return new Q(s)}}const L={"images/blue_pawn.png":he,"images/blue_rook.png":de,"images/blue_knight.png":ge,"images/blue_bishop.png":xe,"images/blue_queen.png":fe,"images/blue_king.png":be},ve={Queen:oe,Rook:ie,Bishop:re,Knight:ae},q=()=>{const c=[new ce(4,7,!0),new H(7,7,!0)];return new Q(c)},Pe=(c,s)=>{const{x:t,y:i}=c.matrixPosition;switch(s.toLowerCase()){case"rook":return new H(t,i,c.white);case"bishop":return new me(t,i,c.white);case"knight":return new ue(t,i,c.white);default:return new le(t,i,c.white)}},S=(c,s)=>c.generateMoves(s).filter(t=>G(s,{from:c.matrixPosition,to:t})!==s),F=(c,s,t)=>t.some(i=>i.x===c&&i.y===s),pe=(c,s)=>{const t=String.fromCharCode(97+c),i=8-s;return t+i},N=(c,s,t)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[c.constructor.name]||"")+pe(s,t),ke=({moveHistory:c,setMoveHistory:s,equippedSkinsMapping:t={}},i)=>{const[g,u]=f.useState(q()),[d,k]=f.useState(null),[O,y]=f.useState(!0),[P,b]=f.useState(null),[J,_]=f.useState(0),[U,W]=f.useState(!1),[B,$]=f.useState(null),M=f.useRef(null),R=f.useRef(null),V=()=>{b("Black wins by resignation")};f.useImperativeHandle(i,()=>({retireGame:V}));const X=()=>{let n="Win";P&&P.includes("Black wins")?n="Lose":P&&P.includes("Draw")&&(n="Draw"),ne.post("/game/result",{moves:c.map(e=>`${e.white} ${e.black}`).join(" | "),time:J,side:"White",result:n}).then(()=>{W(!0)}).catch(()=>{})},Y=()=>{P&&!U&&X(),u(q()),k(null),y(!0),b(null),s([]),M.current=null,R.current=null,_(0),W(!1)},Z=n=>{if(!B)return;const{board:e,pawn:m}=B,l=Pe(m,n);e.pieces=e.pieces.map(a=>a===m?l:a),u(e),$(null),k(null);const o=I(e,!1);if(o){b(o);return}y(!1),setTimeout(()=>{const v=z(e,3,!1).move;if(v){const p=e.getPieceAt(v.from.x,v.from.y),j=N(p,v.to.x,v.to.y),r=G(e,v);if(r!==e){u(r),s(w=>{const C=w.length-1,A={...w[C],black:j};return[...w.slice(0,C),A]});const x=I(r,!0);x&&b(x)}else b("Game over: AI resigns")}else b("Game over: AI resigns");y(!0)},500)},ee=(n,e)=>{if(P||B)return;const m=d?S(d,g):[];if(console.log("Legal moves for selected piece:",m),d&&F(n,e,m)){const o=Date.now();if(!M.current)M.current=o,R.current=o;else{const r=o-R.current;_(x=>x+r),R.current=o}const a=g.clone(),v=N(d,n,e);s(r=>[...r,{white:v,black:""}]);const p=m.find(r=>r.x===n&&r.y===e);if(d.constructor.name==="King"&&p&&p.castling){if(p.castling==="kingside"){a.move(d.matrixPosition,{x:6,y:e});const r=a.getPieceAt(7,e);r&&r.constructor.name==="Rook"&&a.move({x:7,y:e},{x:5,y:e})}else if(p.castling==="queenside"){a.move(d.matrixPosition,{x:2,y:e});const r=a.getPieceAt(0,e);r&&r.constructor.name==="Rook"&&a.move({x:0,y:e},{x:3,y:e})}}else a.move(d.matrixPosition,{x:n,y:e});if(d.constructor.name==="Pawn"){const r=a.getPieceAt(n,e);if(r.white&&r.matrixPosition.y===0||!r.white&&r.matrixPosition.y===7){$({board:a,pawn:r});return}}u(a),k(null);const j=I(a,!1);if(j){b(j);return}y(!1),setTimeout(()=>{const x=z(a,3,!1).move;if(x){const w=a.getPieceAt(x.from.x,x.from.y),C=N(w,x.to.x,x.to.y),A=G(a,x);if(A!==a){u(A),s(K=>{const T=K.length-1,se={...K[T],black:C};return[...K.slice(0,T),se]});const E=I(A,!0);E&&b(E)}else b("Game over: AI resigns")}else b("Game over: AI resigns");y(!0)},500);return}const l=g.getPieceAt(n,e);l&&l.white===O?k(l):k(null)},I=(n,e)=>{let m=[];return n.pieces.forEach(l=>{l.white===e&&(m=m.concat(S(l,n)))}),m.length===0?D(n,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},D=(n,e)=>{const m=n.pieces.find(o=>o.constructor.name==="King"&&o.white===e);if(!m)return!1;let l=[];return n.pieces.forEach(o=>{o.white!==e&&(l=l.concat(o.generateMoves(n)))}),l.some(o=>o.x===m.matrixPosition.x&&o.y===m.matrixPosition.y)},te=d?S(d,g):[];return h.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[h.jsx("div",{className:"chessboard",children:Array(8).fill().map((n,e)=>Array(8).fill().map((m,l)=>h.jsxs("div",{className:`square ${(e+l)%2===0?"light":"dark"}`,onClick:()=>ee(l,e),children:[F(l,e,te)&&h.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),g.pieces.map((o,a)=>{if(o&&o.matrixPosition.x===l&&o.matrixPosition.y===e){const v=o.constructor.name==="King"&&D(g,o.white);return h.jsxs("span",{className:"piece",style:{zIndex:2,border:d===o?"2px solid yellow":"none",borderRadius:"50%"},children:[v&&h.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none"}}),o.white&&t[o.constructor.name]?h.jsx("img",{src:L[t[o.constructor.name]],alt:o.constructor.name,style:{width:"100%",height:"100%"}}):o.render()]},a)}return null})]},`square-${e}-${l}`)))}),B&&h.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:h.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(n=>{const e=t&&t[n]?L[t[n]]:ve[n];return h.jsx("img",{src:e,alt:n,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>Z(n)},n)})})}),P&&h.jsx("div",{className:"modal",children:h.jsxs("div",{className:"modal-content",children:[h.jsx("h2",{children:P}),h.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:h.jsx("button",{onClick:Y,children:"Restart"})})]})})]})},Be=f.forwardRef(ke);export{Be as default};
