import{r as x,j as m,a as ce}from"./app-CtNyehR9.js";import{W as ue,a as me,b as de,c as he,d as _,r as J,R as B,K as R,B as I,Q as $,e as U,P as u}from"./PC-CudesvBm.js";import{B as fe,a as ge,b as xe,c as we,d as pe,e as be}from"./BlueKing-BUktslDH.js";class z{constructor(t){this.pieces=t}getPieceAt(t,o){return this.pieces.find(a=>a.matrixPosition.x===t&&a.matrixPosition.y===o)}move(t,o){const a=this.getPieceAt(t.x,t.y);if(!a){console.error("No piece found at the source position:",t);return}const h=this.getPieceAt(o.x,o.y);h&&h.white!==a.white&&(this.pieces=this.pieces.filter(v=>v!==h)),a.move(o.x,o.y)}clone(){const t=this.pieces.map(o=>o.clone());return new z(t)}}const W={"images/blue_pawn.png":fe,"images/blue_rook.png":ge,"images/blue_knight.png":xe,"images/blue_bishop.png":we,"images/blue_queen.png":pe,"images/blue_king.png":be},ve={Queen:ue,Rook:me,Bishop:de,Knight:he},V=()=>{const i=[new B(0,0,!1),new R(1,0,!1),new I(2,0,!1),new $(3,0,!1),new U(4,0,!1),new I(5,0,!1),new R(6,0,!1),new B(7,0,!1),new u(0,1,!1),new u(1,1,!1),new u(2,1,!1),new u(3,1,!1),new u(4,1,!1),new u(5,1,!1),new u(6,1,!1),new u(7,1,!1),new u(0,6,!0),new u(1,6,!0),new u(2,6,!0),new u(3,6,!0),new u(4,6,!0),new u(5,6,!0),new u(6,6,!0),new u(7,6,!0),new B(0,7,!0),new R(1,7,!0),new I(2,7,!0),new $(3,7,!0),new U(4,7,!0),new I(5,7,!0),new R(6,7,!0),new B(7,7,!0)];return new z(i)},ke=(i,t)=>{const{x:o,y:a}=i.matrixPosition;switch(t.toLowerCase()){case"Rook":return new B(o,a,i.white);case"Bishop":return new I(o,a,i.white);case"Knight":return new R(o,a,i.white);default:return new $(o,a,i.white)}},E=(i,t)=>i.generateMoves(t).filter(o=>_(t,{from:i.matrixPosition,to:o})!==t),X=i=>{const t=equippedSkinsMapping[i.constructor.name];return console.log(`Equipped skin for ${i.constructor.name}:`,t),t&&W.hasOwnProperty(t)?W[t]:null},Y=(i,t,o)=>o.some(a=>a.x===i&&a.y===t),Pe=(i,t)=>{const o=String.fromCharCode(97+i),a=8-t;return o+a},Q=(i,t,o)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[i.constructor.name]||"")+Pe(t,o),ye=({moveHistory:i,setMoveHistory:t,equippedSkinsMapping:o={}},a)=>{const[h,v]=x.useState(V()),[f,k]=x.useState(null),[Z,P]=x.useState(!0),[b,w]=x.useState(null),[ee,D]=x.useState(0),[te,T]=x.useState(!1),[j,L]=x.useState(null),q=x.useRef(null),C=x.useRef(null),ne=()=>{w("Black wins by resignation")};x.useImperativeHandle(a,()=>({retireGame:ne}));const se=()=>{let n="Win";b&&b.includes("Black wins")?n="Lose":b&&b.includes("Draw")&&(n="Draw"),ce.post("/game/result",{moves:i.map(e=>`${e.white} ${e.black}`).join(" | "),time:ee,side:"White",result:n}).then(()=>{T(!0)}).catch(()=>{})},oe=()=>{b&&!te&&se(),v(V()),k(null),P(!0),w(null),t([]),q.current=null,C.current=null,D(0),T(!1)},ie=n=>{if(!j)return;const{board:e,pawn:d}=j,c=ke(d,n);e.pieces=e.pieces.map(r=>r===d?c:r),v(e),L(null),k(null);const s=M(e,!1);if(s){w(s);return}P(!1),setTimeout(()=>{const p=J(e,3,!1).move;if(p){const S=e.getPieceAt(p.from.x,p.from.y),K=Q(S,p.to.x,p.to.y),l=_(e,p);if(l!==e){v(l),t(y=>{const N=y.length-1,A={...y[N],black:K};return[...y.slice(0,N),A]});const g=M(l,!0);g&&w(g)}else w("Game over: AI resigns")}else w("Game over: AI resigns");P(!0)},500)},re=(n,e)=>{if(b||j)return;const d=f?E(f,h):[];if(f&&Y(n,e,d)){const s=Date.now();if(!q.current)q.current=s,C.current=s;else{const l=s-C.current;D(g=>g+l),C.current=s}const r=h.clone(),p=Q(f,n,e);t(l=>[...l,{white:p,black:""}]);const S=d.find(l=>l.x===n&&l.y===e);if(S.castling==="kingside"?(r.move(f.matrixPosition,{x:6,y:e}),r.getPieceAt(7,e)&&r.move({x:7,y:e},{x:5,y:e})):S.castling==="queenside"?(r.move(f.matrixPosition,{x:2,y:e}),r.getPieceAt(0,e)&&r.move({x:0,y:e},{x:3,y:e})):r.move(f.matrixPosition,{x:n,y:e}),f.constructor.name==="Pawn"){const l=r.getPieceAt(n,e);if(l.white&&l.matrixPosition.y===0||!l.white&&l.matrixPosition.y===7){L({board:r,pawn:l});return}}v(r),k(null);const K=M(r,!1);if(K){w(K);return}P(!1),setTimeout(()=>{const g=J(r,3,!1).move;if(g){const y=r.getPieceAt(g.from.x,g.from.y),N=Q(y,g.to.x,g.to.y),A=_(r,g);if(A!==r){v(A),t(G=>{const H=G.length-1,le={...G[H],black:N};return[...G.slice(0,H),le]});const F=M(A,!0);F&&w(F)}else w("Game over: AI resigns")}else w("Game over: AI resigns");P(!0)},500);return}const c=h.getPieceAt(n,e);c&&c.white===Z?k(c):k(null)},M=(n,e)=>{let d=[];return n.pieces.forEach(c=>{c.white===e&&(d=d.concat(E(c,n)))}),d.length===0?O(n,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},O=(n,e)=>{const d=n.pieces.find(s=>s.constructor.name==="King"&&s.white===e);if(!d)return!1;let c=[];return n.pieces.forEach(s=>{s.white!==e&&(c=c.concat(s.generateMoves(n)))}),c.some(s=>s.x===d.matrixPosition.x&&s.y===d.matrixPosition.y)},ae=f?E(f,h):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((n,e)=>Array(8).fill().map((d,c)=>m.jsxs("div",{className:`square ${(e+c)%2===0?"light":"dark"}`,onClick:()=>re(c,e),children:[Y(c,e,ae)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),h.pieces.map((s,r)=>{if(s&&s.matrixPosition.x===c&&s.matrixPosition.y===e){const p=s.constructor.name==="King"&&O(h,s.white);return m.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:f===s?"2px solid yellow":"none",borderRadius:"50%"},children:[p&&m.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),s.white&&X(s)?m.jsx("img",{src:X(s),alt:s.constructor.name,style:{width:"100%",height:"100%"}}):s.render()]},r)}return null})]},`square-${e}-${c}`)))}),j&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(n=>{const e=o&&o[n]?W[o[n]]:ve[n];return m.jsx("img",{src:e,alt:n,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>ie(n)},n)})})}),b&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:b}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:oe,children:"Restart"})})]})})]})},Ie=x.forwardRef(ye);export{Ie as default};
