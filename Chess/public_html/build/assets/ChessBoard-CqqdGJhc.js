import{r as f,j as m,a as le}from"./app-Cs82XJEq.js";import{W as ue,a as me,b as de,c as he,d as $,r as J,K as U,P as b,R as E,e as Q,B as T,Q as Y}from"./PC-p6sPNhKj.js";import{B as ge,a as fe,b as xe,c as we,d as pe,e as be}from"./BlueKing-BUktslDH.js";class W{constructor(s){this.pieces=s}getPieceAt(s,o){return this.pieces.find(c=>c.matrixPosition.x===s&&c.matrixPosition.y===o)}move(s,o){const c=this.getPieceAt(s.x,s.y);if(!c){console.error("No piece found at the source position:",s);return}const d=this.getPieceAt(o.x,o.y);d&&d.white!==c.white&&(this.pieces=this.pieces.filter(k=>k!==d)),c.move(o.x,o.y)}clone(){const s=this.pieces.map(o=>o.clone());return new W(s)}}const N={blue_pawn:ge,blue_rook:fe,blue_knight:xe,blue_bishop:we,blue_queen:pe,blue_king:be},ke={Queen:ue,Rook:me,Bishop:de,Knight:he},V=()=>{const a=[new U(4,0,!1),new b(0,6,!0),new b(1,6,!0),new b(2,6,!0),new b(3,6,!0),new b(4,6,!0),new b(5,6,!0),new b(6,6,!0),new b(7,6,!0),new E(0,7,!0),new Q(1,7,!0),new T(2,7,!0),new Y(3,7,!0),new U(4,7,!0),new T(5,7,!0),new Q(6,7,!0),new E(7,7,!0)];return new W(a)},ve=(a,s)=>{const{x:o,y:c}=a.matrixPosition;switch(s.toLowerCase()){case"rook":return new E(o,c,a.white);case"bishop":return new T(o,c,a.white);case"knight":return new Q(o,c,a.white);default:return new Y(o,c,a.white)}},G=(a,s)=>a.generateMoves(s).filter(o=>$(s,{from:a.matrixPosition,to:o})!==s),X=(a,s,o)=>o.some(c=>c.x===a&&c.y===s),Pe=(a,s)=>{const o=String.fromCharCode(97+a),c=8-s;return o+c},q=(a,s,o)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[a.constructor.name]||"")+Pe(s,o),ye=a=>a.constructor.type||a.constructor.name.toLowerCase(),Ae=({moveHistory:a,setMoveHistory:s,equippedSkinsMapping:o={}},c)=>{const[d,k]=f.useState(V()),[h,v]=f.useState(null),[Z,P]=f.useState(!0),[p,x]=f.useState(null),[ee,_]=f.useState(0),[te,L]=f.useState(!1),[B,z]=f.useState(null),S=f.useRef(null),R=f.useRef(null),D=t=>{const e=t.constructor.name.toLowerCase(),i=o[e];return console.log(`Equipped skin for ${t.constructor.name}:`,i),i&&N.hasOwnProperty(i)?N[i]:null},ne=()=>{x("Black wins by resignation")};f.useImperativeHandle(c,()=>({retireGame:ne}));const se=()=>{let t="Win";p&&p.includes("Black wins")?t="Lose":p&&p.includes("Draw")&&(t="Draw"),le.post("/game/result",{moves:a.map(e=>`${e.white} ${e.black}`).join(" | "),time:ee,side:"White",result:t}).then(()=>{L(!0)}).catch(()=>{})},oe=()=>{p&&!te&&se(),k(V()),v(null),P(!0),x(null),s([]),S.current=null,R.current=null,_(0),L(!1)},ie=t=>{if(console.log("Promotion choice:",t),!B)return;const{board:e,pawn:i}=B,u=ve(i,t);e.pieces=e.pieces.map(n=>n===i?u:n),k(e),z(null),v(null);const r=I(e,!1);if(r){x(r);return}P(!1),setTimeout(()=>{const w=J(e,3,!1).move;if(w){const C=e.getPieceAt(w.from.x,w.from.y),j=q(C,w.to.x,w.to.y),l=$(e,w);if(l!==e){k(l),s(y=>{const M=y.length-1,A={...y[M],black:j};return[...y.slice(0,M),A]});const g=I(l,!0);g&&x(g)}else x("Game over: AI resigns")}else x("Game over: AI resigns");P(!0)},500)},re=(t,e)=>{if(p||B)return;const i=h?G(h,d):[];if(h&&X(t,e,i)){const r=Date.now();if(!S.current)S.current=r,R.current=r;else{const l=r-R.current;_(g=>g+l),R.current=r}const n=d.clone(),w=q(h,t,e);s(l=>[...l,{white:w,black:""}]);const C=i.find(l=>l.x===t&&l.y===e);if(C.castling==="kingside"?(n.move(h.matrixPosition,{x:6,y:e}),n.getPieceAt(7,e)&&n.move({x:7,y:e},{x:5,y:e})):C.castling==="queenside"?(n.move(h.matrixPosition,{x:2,y:e}),n.getPieceAt(0,e)&&n.move({x:0,y:e},{x:3,y:e})):n.move(h.matrixPosition,{x:t,y:e}),h.constructor.name==="Pawn"){const l=n.getPieceAt(t,e);if(l.white&&l.matrixPosition.y===0||!l.white&&l.matrixPosition.y===7){console.log("Pawn promotion triggered for:",l),z({board:n,pawn:l});return}}k(n),v(null);const j=I(n,!1);if(j){x(j);return}P(!1),setTimeout(()=>{const g=J(n,3,!1).move;if(g){const y=n.getPieceAt(g.from.x,g.from.y),M=q(y,g.to.x,g.to.y),A=$(n,g);if(A!==n){k(A),s(K=>{const H=K.length-1,ce={...K[H],black:M};return[...K.slice(0,H),ce]});const F=I(A,!0);F&&x(F)}else x("Game over: AI resigns")}else x("Game over: AI resigns");P(!0)},500);return}const u=d.getPieceAt(t,e);u&&u.white===Z?v(u):v(null)},I=(t,e)=>{let i=[];return t.pieces.forEach(u=>{u.white===e&&(i=i.concat(G(u,t)))}),i.length===0?O(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},O=(t,e)=>{const i=t.pieces.find(n=>n.constructor.name==="King"&&n.white===e);if(!i)return!1;let u=[];t.pieces.forEach(n=>{n.white!==e&&(u=u.concat(n.generateMoves(t)))});const r=u.some(n=>n.x===i.matrixPosition.x&&n.y===i.matrixPosition.y);return r&&console.log(`King (${i.white?"White":"Black"}) is in check`),r},ae=h?G(h,d):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((i,u)=>m.jsxs("div",{className:`square ${(e+u)%2===0?"light":"dark"}`,onClick:()=>re(u,e),style:{position:"relative"},children:[X(u,e,ae)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),d.pieces.map((r,n)=>{if(r&&r.matrixPosition.x===u&&r.matrixPosition.y===e){const w=r.constructor.name==="King"&&O(d,r.white);return m.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:h===r?"2px solid yellow":"none",borderRadius:"50%"},children:[w&&m.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),r.white&&D(r)?m.jsx("img",{src:D(r),alt:ye(r),style:{width:"100%",height:"100%"}}):r.render()]},n)}return null})]},`square-${e}-${u}`)))}),B&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=t.toLowerCase(),i=o&&o[e]?N[o[e]]:ke[t];return m.jsx("img",{src:i,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>ie(t)},t)})})}),p&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:p}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:oe,children:"Restart"})})]})})]})},Ce=f.forwardRef(Ae);export{Ce as default};
