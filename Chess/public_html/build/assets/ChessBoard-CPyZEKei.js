import{r as x,j as m,a as le}from"./app-DFjWCmx6.js";import{W as ce,a as ue,b as me,c as de,d as $,r as O,R as B,K as R,B as I,Q as z,e as J,P as u}from"./PC-oQe50dvh.js";import{B as he,a as fe,b as ge,c as xe,d as we,e as be}from"./BlueKing-BUktslDH.js";class D{constructor(o){this.pieces=o}getPieceAt(o,s){return this.pieces.find(r=>r.matrixPosition.x===o&&r.matrixPosition.y===s)}move(o,s){const r=this.getPieceAt(o.x,o.y);if(!r){console.error("No piece found at the source position:",o);return}const h=this.getPieceAt(s.x,s.y);h&&h.white!==r.white&&(this.pieces=this.pieces.filter(p=>p!==h)),r.move(s.x,s.y)}clone(){const o=this.pieces.map(s=>s.clone());return new D(o)}}const U={"images/blue_pawn.png":he,"images/blue_rook.png":fe,"images/blue_knight.png":ge,"images/blue_bishop.png":xe,"images/blue_queen.png":we,"images/blue_king.png":be},ve={Queen:ce,Rook:ue,Bishop:me,Knight:de},V=()=>{const l=[new B(0,0,!1),new R(1,0,!1),new I(2,0,!1),new z(3,0,!1),new J(4,0,!1),new I(5,0,!1),new R(6,0,!1),new B(7,0,!1),new u(0,1,!1),new u(1,1,!1),new u(2,1,!1),new u(3,1,!1),new u(4,1,!1),new u(5,1,!1),new u(6,1,!1),new u(7,1,!1),new u(0,6,!0),new u(1,6,!0),new u(2,6,!0),new u(3,6,!0),new u(4,6,!0),new u(5,6,!0),new u(6,6,!0),new u(7,6,!0),new B(0,7,!0),new R(1,7,!0),new I(2,7,!0),new z(3,7,!0),new J(4,7,!0),new I(5,7,!0),new R(6,7,!0),new B(7,7,!0)];return new D(l)},pe=(l,o)=>{const{x:s,y:r}=l.matrixPosition;switch(o.toLowerCase()){case"rook":return new B(s,r,l.white);case"bishop":return new I(s,r,l.white);case"knight":return new R(s,r,l.white);default:return new z(s,r,l.white)}},_=(l,o)=>l.generateMoves(o).filter(s=>$(o,{from:l.matrixPosition,to:s})!==o),X=(l,o,s)=>s.some(r=>r.x===l&&r.y===o),Pe=(l,o)=>{const s=String.fromCharCode(97+l),r=8-o;return s+r},W=(l,o,s)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[l.constructor.name]||"")+Pe(o,s),ke=({moveHistory:l,setMoveHistory:o,equippedSkinsMapping:s={}},r)=>{const[h,p]=x.useState(V()),[f,P]=x.useState(null),[Y,k]=x.useState(!0),[v,w]=x.useState(null),[Z,E]=x.useState(0),[ee,L]=x.useState(!1),[C,T]=x.useState(null),G=x.useRef(null),j=x.useRef(null),te=()=>{w("Black wins by resignation")};x.useImperativeHandle(r,()=>({retireGame:te}));const ne=()=>{let t="Win";v&&v.includes("Black wins")?t="Lose":v&&v.includes("Draw")&&(t="Draw"),le.post("/game/result",{moves:l.map(e=>`${e.white} ${e.black}`).join(" | "),time:Z,side:"White",result:t}).then(()=>{L(!0)}).catch(()=>{})},se=()=>{v&&!ee&&ne(),p(V()),P(null),k(!0),w(null),o([]),G.current=null,j.current=null,E(0),L(!1)},oe=t=>{if(!C)return;const{board:e,pawn:d}=C,c=pe(d,t);e.pieces=e.pieces.map(i=>i===d?c:i),p(e),T(null),P(null);const n=M(e,!1);if(n){w(n);return}k(!1),setTimeout(()=>{const b=O(e,3,!1).move;if(b){const K=e.getPieceAt(b.from.x,b.from.y),S=W(K,b.to.x,b.to.y),a=$(e,b);if(a!==e){p(a),o(y=>{const N=y.length-1,A={...y[N],black:S};return[...y.slice(0,N),A]});const g=M(a,!0);g&&w(g)}else w("Game over: AI resigns")}else w("Game over: AI resigns");k(!0)},500)},ie=(t,e)=>{if(v||C)return;const d=f?_(f,h):[];if(f&&X(t,e,d)){const n=Date.now();if(!G.current)G.current=n,j.current=n;else{const a=n-j.current;E(g=>g+a),j.current=n}const i=h.clone(),b=W(f,t,e);o(a=>[...a,{white:b,black:""}]);const K=d.find(a=>a.x===t&&a.y===e);if(K.castling==="kingside"?(i.move(f.matrixPosition,{x:6,y:e}),i.getPieceAt(7,e)&&i.move({x:7,y:e},{x:5,y:e})):K.castling==="queenside"?(i.move(f.matrixPosition,{x:2,y:e}),i.getPieceAt(0,e)&&i.move({x:0,y:e},{x:3,y:e})):i.move(f.matrixPosition,{x:t,y:e}),f.constructor.name==="Pawn"){const a=i.getPieceAt(t,e);if(a.white&&a.matrixPosition.y===0||!a.white&&a.matrixPosition.y===7){T({board:i,pawn:a});return}}p(i),P(null);const S=M(i,!1);if(S){w(S);return}k(!1),setTimeout(()=>{const g=O(i,3,!1).move;if(g){const y=i.getPieceAt(g.from.x,g.from.y),N=W(y,g.to.x,g.to.y),A=$(i,g);if(A!==i){p(A),o(Q=>{const H=Q.length-1,ae={...Q[H],black:N};return[...Q.slice(0,H),ae]});const F=M(A,!0);F&&w(F)}else w("Game over: AI resigns")}else w("Game over: AI resigns");k(!0)},500);return}const c=h.getPieceAt(t,e);c&&c.white===Y?P(c):P(null)},M=(t,e)=>{let d=[];return t.pieces.forEach(c=>{c.white===e&&(d=d.concat(_(c,t)))}),d.length===0?q(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},q=(t,e)=>{const d=t.pieces.find(n=>n.constructor.name==="King"&&n.white===e);if(!d)return!1;let c=[];return t.pieces.forEach(n=>{n.white!==e&&(c=c.concat(n.generateMoves(t)))}),c.some(n=>n.x===d.matrixPosition.x&&n.y===d.matrixPosition.y)},re=f?_(f,h):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((d,c)=>m.jsxs("div",{className:`square ${(e+c)%2===0?"light":"dark"}`,onClick:()=>ie(c,e),children:[X(c,e,re)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),h.pieces.map((n,i)=>{if(n&&n.matrixPosition.x===c&&n.matrixPosition.y===e){const b=n.constructor.name==="King"&&q(h,n.white);return m.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:f===n?"2px solid yellow":"none",borderRadius:"50%"},children:[b&&m.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),n.white&&s[n.constructor.name.toLowerCase()]?m.jsx("img",{src:U[s[n.constructor.name.toLowerCase()]],alt:n.constructor.name,style:{width:"100%",height:"100%"}}):n.render()]},i)}return null})]},`square-${e}-${c}`)))}),C&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=s&&s[t]?U[s[t]]:ve[t];return m.jsx("img",{src:e,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>oe(t)},t)})})}),v&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:v}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:se,children:"Restart"})})]})})]})},Re=x.forwardRef(ke);export{Re as default};
