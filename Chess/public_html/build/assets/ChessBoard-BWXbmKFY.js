import{r as x,j as m,a as ce}from"./app-DnPUhcHn.js";import{W as ue,a as me,b as de,c as he,d as $,r as U,R as B,K as R,B as I,Q as W,e as V,P as u}from"./PC-9BQKEQ5q.js";import{B as fe,a as ge,b as xe,c as we,d as pe,e as be}from"./BlueKing-BUktslDH.js";class z{constructor(s){this.pieces=s}getPieceAt(s,o){return this.pieces.find(r=>r.matrixPosition.x===s&&r.matrixPosition.y===o)}move(s,o){const r=this.getPieceAt(s.x,s.y);if(!r){console.error("No piece found at the source position:",s);return}const h=this.getPieceAt(o.x,o.y);h&&h.white!==r.white&&(this.pieces=this.pieces.filter(v=>v!==h)),r.move(o.x,o.y)}clone(){const s=this.pieces.map(o=>o.clone());return new z(s)}}const E={"images/blue_pawn.png":fe,"images/blue_rook.png":ge,"images/blue_knight.png":xe,"images/blue_bishop.png":we,"images/blue_queen.png":pe,"images/blue_king.png":be},ve={Queen:ue,Rook:me,Bishop:de,Knight:he},X=()=>{const l=[new B(0,0,!1),new R(1,0,!1),new I(2,0,!1),new W(3,0,!1),new V(4,0,!1),new I(5,0,!1),new R(6,0,!1),new B(7,0,!1),new u(0,1,!1),new u(1,1,!1),new u(2,1,!1),new u(3,1,!1),new u(4,1,!1),new u(5,1,!1),new u(6,1,!1),new u(7,1,!1),new u(0,6,!0),new u(1,6,!0),new u(2,6,!0),new u(3,6,!0),new u(4,6,!0),new u(5,6,!0),new u(6,6,!0),new u(7,6,!0),new B(0,7,!0),new R(1,7,!0),new I(2,7,!0),new W(3,7,!0),new V(4,7,!0),new I(5,7,!0),new R(6,7,!0),new B(7,7,!0)];return new z(l)},Pe=(l,s)=>{const{x:o,y:r}=l.matrixPosition;switch(s.toLowerCase()){case"Rook":return new B(o,r,l.white);case"Bishop":return new I(o,r,l.white);case"Knight":return new R(o,r,l.white);default:return new W(o,r,l.white)}},Q=(l,s)=>l.generateMoves(s).filter(o=>$(s,{from:l.matrixPosition,to:o})!==s),Y=(l,s,o)=>o.some(r=>r.x===l&&r.y===s),ke=(l,s)=>{const o=String.fromCharCode(97+l),r=8-s;return o+r},_=(l,s,o)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[l.constructor.name]||"")+ke(s,o),ye=({moveHistory:l,setMoveHistory:s,equippedSkinsMapping:o={}},r)=>{const[h,v]=x.useState(X()),[f,P]=x.useState(null),[Z,k]=x.useState(!0),[b,w]=x.useState(null),[ee,D]=x.useState(0),[te,T]=x.useState(!1),[j,L]=x.useState(null),G=x.useRef(null),C=x.useRef(null),O=t=>{const e=o[t.constructor.name];return console.log(`Equipped skin for ${t.constructor.name}:`,e),e&&E.hasOwnProperty(e)?E[e]:null},ne=()=>{w("Black wins by resignation")};x.useImperativeHandle(r,()=>({retireGame:ne}));const se=()=>{let t="Win";b&&b.includes("Black wins")?t="Lose":b&&b.includes("Draw")&&(t="Draw"),ce.post("/game/result",{moves:l.map(e=>`${e.white} ${e.black}`).join(" | "),time:ee,side:"White",result:t}).then(()=>{T(!0)}).catch(()=>{})},oe=()=>{b&&!te&&se(),v(X()),P(null),k(!0),w(null),s([]),G.current=null,C.current=null,D(0),T(!1)},ie=t=>{if(!j)return;const{board:e,pawn:d}=j,c=Pe(d,t);e.pieces=e.pieces.map(i=>i===d?c:i),v(e),L(null),P(null);const n=M(e,!1);if(n){w(n);return}k(!1),setTimeout(()=>{const p=U(e,3,!1).move;if(p){const S=e.getPieceAt(p.from.x,p.from.y),K=_(S,p.to.x,p.to.y),a=$(e,p);if(a!==e){v(a),s(y=>{const N=y.length-1,A={...y[N],black:K};return[...y.slice(0,N),A]});const g=M(a,!0);g&&w(g)}else w("Game over: AI resigns")}else w("Game over: AI resigns");k(!0)},500)},re=(t,e)=>{if(b||j)return;const d=f?Q(f,h):[];if(f&&Y(t,e,d)){const n=Date.now();if(!G.current)G.current=n,C.current=n;else{const a=n-C.current;D(g=>g+a),C.current=n}const i=h.clone(),p=_(f,t,e);s(a=>[...a,{white:p,black:""}]);const S=d.find(a=>a.x===t&&a.y===e);if(S.castling==="kingside"?(i.move(f.matrixPosition,{x:6,y:e}),i.getPieceAt(7,e)&&i.move({x:7,y:e},{x:5,y:e})):S.castling==="queenside"?(i.move(f.matrixPosition,{x:2,y:e}),i.getPieceAt(0,e)&&i.move({x:0,y:e},{x:3,y:e})):i.move(f.matrixPosition,{x:t,y:e}),f.constructor.name==="Pawn"){const a=i.getPieceAt(t,e);if(a.white&&a.matrixPosition.y===0||!a.white&&a.matrixPosition.y===7){L({board:i,pawn:a});return}}v(i),P(null);const K=M(i,!1);if(K){w(K);return}k(!1),setTimeout(()=>{const g=U(i,3,!1).move;if(g){const y=i.getPieceAt(g.from.x,g.from.y),N=_(y,g.to.x,g.to.y),A=$(i,g);if(A!==i){v(A),s(q=>{const J=q.length-1,le={...q[J],black:N};return[...q.slice(0,J),le]});const H=M(A,!0);H&&w(H)}else w("Game over: AI resigns")}else w("Game over: AI resigns");k(!0)},500);return}const c=h.getPieceAt(t,e);c&&c.white===Z?P(c):P(null)},M=(t,e)=>{let d=[];return t.pieces.forEach(c=>{c.white===e&&(d=d.concat(Q(c,t)))}),d.length===0?F(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},F=(t,e)=>{const d=t.pieces.find(n=>n.constructor.name==="King"&&n.white===e);if(!d)return!1;let c=[];return t.pieces.forEach(n=>{n.white!==e&&(c=c.concat(n.generateMoves(t)))}),c.some(n=>n.x===d.matrixPosition.x&&n.y===d.matrixPosition.y)},ae=f?Q(f,h):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((d,c)=>m.jsxs("div",{className:`square ${(e+c)%2===0?"light":"dark"}`,onClick:()=>re(c,e),children:[Y(c,e,ae)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),h.pieces.map((n,i)=>{if(n&&n.matrixPosition.x===c&&n.matrixPosition.y===e){const p=n.constructor.name==="King"&&F(h,n.white);return m.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:f===n?"2px solid yellow":"none",borderRadius:"50%"},children:[p&&m.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),n.white&&O(n)?m.jsx("img",{src:O(n),alt:n.constructor.name,style:{width:"100%",height:"100%"}}):n.render()]},i)}return null})]},`square-${e}-${c}`)))}),j&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=o&&o[t]?E[o[t]]:ve[t];return m.jsx("img",{src:e,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>ie(t)},t)})})}),b&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:b}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:oe,children:"Restart"})})]})})]})},Ie=x.forwardRef(ye);export{Ie as default};
