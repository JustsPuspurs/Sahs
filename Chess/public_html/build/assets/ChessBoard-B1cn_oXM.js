import{r as P,j as m,a as ce}from"./app-CnohEUH0.js";import{W as le,a as ue,b as me,c as he,d as G,r as F,R,K as I,B as j,Q as D,e as J,P as l}from"./PC-D5KEJsuG.js";import{B as de,a as fe,b as ge,c as xe,d as we,e as Pe}from"./BlueKing-BUktslDH.js";class E{constructor(s){this.pieces=s}getPieceAt(s,t){return this.pieces.find(o=>o.matrixPosition.x===s&&o.matrixPosition.y===t)}move(s,t){const o=this.getPieceAt(s.x,s.y);if(!o){console.error("No piece found at the source position:",s);return}const f=this.getPieceAt(t.x,t.y);if(f&&f.white!==o.white&&(this.pieces=this.pieces.filter(u=>u!==f)),o.constructor.name==="King"&&Math.abs(t.x-o.matrixPosition.x)===2){const u=s.y;if(t.x>o.matrixPosition.x){const r=this.getPieceAt(7,u);if(r&&r.constructor.name==="Rook"&&!r.hasMoved&&!this.getPieceAt(5,u)&&!this.getPieceAt(6,u)){const g={...o.matrixPosition};o.move(r.matrixPosition.x,r.matrixPosition.y),r.move(g.x,g.y);return}}else{const r=this.getPieceAt(0,u);if(r&&r.constructor.name==="Rook"&&!r.hasMoved&&!this.getPieceAt(1,u)&&!this.getPieceAt(2,u)&&!this.getPieceAt(3,u)){const g={...o.matrixPosition};o.move(r.matrixPosition.x,r.matrixPosition.y),r.move(g.x,g.y);return}}}o.move(t.x,t.y)}clone(){const s=this.pieces.map(t=>t.clone());return new E(s)}}const U={"images/blue_pawn.png":de,"images/blue_rook.png":fe,"images/blue_knight.png":ge,"images/blue_bishop.png":xe,"images/blue_queen.png":we,"images/blue_king.png":Pe},be={Queen:le,Rook:ue,Bishop:me,Knight:he},V=()=>{const a=[new R(0,0,!1),new I(1,0,!1),new j(2,0,!1),new D(3,0,!1),new J(4,0,!1),new j(5,0,!1),new I(6,0,!1),new R(7,0,!1),new l(0,1,!1),new l(1,1,!1),new l(2,1,!1),new l(3,1,!1),new l(4,1,!1),new l(5,1,!1),new l(6,1,!1),new l(7,1,!1),new l(0,6,!0),new l(1,6,!0),new l(2,6,!0),new l(3,6,!0),new l(4,6,!0),new l(5,6,!0),new l(6,6,!0),new l(7,6,!0),new R(0,7,!0),new I(1,7,!0),new j(2,7,!0),new D(3,7,!0),new J(4,7,!0),new j(5,7,!0),new I(6,7,!0),new R(7,7,!0)];return new E(a)},pe=(a,s)=>{const{x:t,y:o}=a.matrixPosition;switch(s.toLowerCase()){case"rook":return new R(t,o,a.white);case"bishop":return new j(t,o,a.white);case"knight":return new I(t,o,a.white);default:return new D(t,o,a.white)}},W=(a,s)=>a.generateMoves(s).filter(t=>G(s,{from:a.matrixPosition,to:t})!==s),X=(a,s,t)=>t.some(o=>o.x===a&&o.y===s),ve=(a,s)=>{const t=String.fromCharCode(97+a),o=8-s;return t+o},$=(a,s,t)=>({Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"}[a.constructor.name]||"")+ve(s,t),ke=({moveHistory:a,setMoveHistory:s,equippedSkinsMapping:t={}},o)=>{const[f,u]=P.useState(V()),[r,g]=P.useState(null),[Y,y]=P.useState(!0),[v,b]=P.useState(null),[Z,T]=P.useState(0),[ee,z]=P.useState(!1),[C,q]=P.useState(null),Q=P.useRef(null),M=P.useRef(null),te=()=>{b("Black wins by resignation")};P.useImperativeHandle(o,()=>({retireGame:te}));const ne=()=>{let i="Win";v&&v.includes("Black wins")?i="Lose":v&&v.includes("Draw")&&(i="Draw"),ce.post("/game/result",{moves:a.map(e=>`${e.white} ${e.black}`).join(" | "),time:Z,side:"White",result:i}).then(()=>{z(!0)}).catch(()=>{})},se=()=>{v&&!ee&&ne(),u(V()),g(null),y(!0),b(null),s([]),Q.current=null,M.current=null,T(0),z(!1)},oe=i=>{if(!C)return;const{board:e,pawn:d}=C,c=pe(d,i);e.pieces=e.pieces.map(k=>k===d?c:k),u(e),q(null),g(null);const n=K(e,!1);if(n){b(n);return}y(!1),setTimeout(()=>{const p=F(e,3,!1).move;if(p){const x=e.getPieceAt(p.from.x,p.from.y),S=$(x,p.to.x,p.to.y),h=G(e,p);if(h!==e){u(h),s(A=>{const N=A.length-1,B={...A[N],black:S};return[...A.slice(0,N),B]});const w=K(h,!0);w&&b(w)}else b("Game over: AI resigns")}else b("Game over: AI resigns");y(!0)},500)},ie=(i,e)=>{if(v||C)return;const d=r?W(r,f):[];if(r&&X(i,e,d)){const n=Date.now();if(!Q.current)Q.current=n,M.current=n;else{const h=n-M.current;T(w=>w+h),M.current=n}const k=f.clone(),p=$(r,i,e);s(h=>[...h,{white:p,black:""}]);const x=G(k,{from:r.matrixPosition,to:{x:i,y:e}});if(x===k)return;if(r.constructor.name==="Pawn"){const h=x.getPieceAt(i,e);if(h.white&&h.matrixPosition.y===0||!h.white&&h.matrixPosition.y===7){q({board:x,pawn:h});return}}u(x),g(null);const S=K(x,!1);if(S){b(S);return}y(!1),setTimeout(()=>{const w=F(x,3,!1).move;if(w){const A=x.getPieceAt(w.from.x,w.from.y),N=$(A,w.to.x,w.to.y),B=G(x,w);if(B!==x){u(B),s(_=>{const H=_.length-1,ae={..._[H],black:N};return[..._.slice(0,H),ae]});const O=K(B,!0);O&&b(O)}else b("Game over: AI resigns")}else b("Game over: AI resigns");y(!0)},500);return}const c=f.getPieceAt(i,e);c&&c.white===Y?g(c):g(null)},K=(i,e)=>{let d=[];return i.pieces.forEach(c=>{c.white===e&&(d=d.concat(W(c,i)))}),d.length===0?L(i,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},L=(i,e)=>{const d=i.pieces.find(n=>n.constructor.name==="King"&&n.white===e);if(!d)return!1;let c=[];return i.pieces.forEach(n=>{n.white!==e&&(c=c.concat(n.generateMoves(i)))}),c.some(n=>n.x===d.matrixPosition.x&&n.y===d.matrixPosition.y)},re=r?W(r,f):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((i,e)=>Array(8).fill().map((d,c)=>m.jsxs("div",{className:`square ${(e+c)%2===0?"light":"dark"}`,onClick:()=>ie(c,e),children:[X(c,e,re)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),f.pieces.map((n,k)=>{if(n&&n.matrixPosition.x===c&&n.matrixPosition.y===e){const p=n.constructor.name==="King"&&L(f,n.white);return m.jsxs("span",{className:"piece",style:{zIndex:2,border:r===n?"2px solid yellow":"none",borderRadius:"50%"},children:[p&&m.jsx("div",{style:{position:"absolute",width:"55px",height:"55px",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none"}}),n.white&&t[n.constructor.name]?m.jsx("img",{src:U[t[n.constructor.name]],alt:n.constructor.name,style:{width:"100%",height:"100%"}}):n.render()]},k)}return null})]},`square-${e}-${c}`)))}),C&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(i=>{const e=t[i]?U[t[i]]:be[i];return m.jsx("img",{src:e,alt:i,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>oe(i)},i)})})}),v&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:v}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:se,children:"Restart"})})]})})]})},Re=P.forwardRef(ke);export{Re as default};
