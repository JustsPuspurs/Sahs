import{r as x,j as m,a as ue}from"./app-BuQ60WTZ.js";import{W as he,a as me,b as fe,c as de,d as W,r as U,R,K as C,B as I,Q as _,e as J,P as h}from"./PC-hW-DHnNv.js";import{B as ge,a as xe,b as we,c as pe,d as ye,e as ke}from"./BlueKing-BUktslDH.js";class q{constructor(o){this.pieces=o}getPieceAt(o,s){return this.pieces.find(l=>l.matrixPosition.x===o&&l.matrixPosition.y===s)}move(o,s){const l=this.getPieceAt(o.x,o.y);if(!l){console.error("No piece found at the source position:",o);return}const f=this.getPieceAt(s.x,s.y);f&&f.white!==l.white&&(this.pieces=this.pieces.filter(y=>y!==f)),l.move(s.x,s.y)}clone(){const o=this.pieces.map(s=>s.clone());return new q(o)}}const E={blue_pawn:ge,blue_rook:xe,blue_knight:we,blue_bishop:pe,blue_queen:ye,blue_king:ke},be={Queen:he,Rook:me,Bishop:fe,Knight:de},V=()=>{const a=[new R(0,0,!1),new C(1,0,!1),new I(2,0,!1),new _(3,0,!1),new J(4,0,!1),new I(5,0,!1),new C(6,0,!1),new R(7,0,!1),new h(0,1,!1),new h(1,1,!1),new h(2,1,!1),new h(3,1,!1),new h(4,1,!1),new h(5,1,!1),new h(6,1,!1),new h(7,1,!1),new h(0,6,!0),new h(1,6,!0),new h(2,6,!0),new h(3,6,!0),new h(4,6,!0),new h(5,6,!0),new h(6,6,!0),new h(7,6,!0),new R(0,7,!0),new C(1,7,!0),new I(2,7,!0),new _(3,7,!0),new J(4,7,!0),new I(5,7,!0),new C(6,7,!0),new R(7,7,!0)];return new q(a)},Pe=(a,o)=>{const{x:s,y:l}=a.matrixPosition;switch(o.toLowerCase()){case"rook":return new R(s,l,a.white);case"bishop":return new I(s,l,a.white);case"knight":return new C(s,l,a.white);default:return new _(s,l,a.white)}},Q=(a,o)=>a.generateMoves(o).filter(s=>W(o,{from:a.matrixPosition,to:s})!==o),X=(a,o,s)=>s.some(l=>l.x===a&&l.y===o),ve=(a,o)=>{const s=String.fromCharCode(97+a),l=8-o;return s+l},T=(a,o,s)=>{const l={Pawn:"",Knight:"n",Bishop:"b",Rook:"r",Queen:"q",King:"k"},f=Y(a);return(l[f.charAt(0).toUpperCase()+f.slice(1)]||"")+ve(o,s)},Y=a=>a.constructor.type||a.constructor.name.toLowerCase(),Ae=({moveHistory:a,setMoveHistory:o,equippedSkinsMapping:s={}},l)=>{const[f,y]=x.useState(V()),[d,P]=x.useState(null),[Z,v]=x.useState(!0),[k,w]=x.useState(null),[ee,L]=x.useState(0),[te,z]=x.useState(!1),[j,D]=x.useState(null),G=x.useRef(null),S=x.useRef(null),ne=t=>{const e=Y(t);let i=s[e];return console.log(`Equipped skin for ${e}:`,i),i&&(i=i.replace("images/","").replace(".png",""),E.hasOwnProperty(i))?E[i]:null},se=()=>{w("Black wins by resignation")};x.useImperativeHandle(l,()=>({retireGame:se}));const oe=()=>{let t="Win";k&&k.includes("Black wins")?t="Lose":k&&k.includes("Draw")&&(t="Draw"),ue.post("/game/result",{moves:a.map(e=>`${e.white} ${e.black}`).join(" | "),time:ee,side:"White",result:t}).then(()=>z(!0)).catch(()=>{})},ie=()=>{k&&!te&&oe(),y(V()),P(null),v(!0),w(null),o([]),G.current=null,S.current=null,L(0),z(!1)},re=t=>{if(console.log("Promotion choice:",t),!j)return;const{board:e,pawn:i}=j,u=Pe(i,t);e.pieces=e.pieces.map(n=>n===i?u:n),y(e),D(null),P(null);const r=K(e,!1);if(r){w(r);return}v(!1),setTimeout(()=>{const p=U(e,3,!1).move;if(p){const b=e.getPieceAt(p.from.x,p.from.y),N=T(b,p.to.x,p.to.y),c=W(e,p);if(c!==e){y(c),o(A=>{const M=A.length-1,B={...A[M],black:N};return[...A.slice(0,M),B]});const g=K(c,!0);g&&w(g)}else w("Game over: AI resigns")}else w("Game over: AI resigns");v(!0)},500)},ae=(t,e)=>{if(k||j)return;const i=d?Q(d,f):[];if(d&&X(t,e,i)){const r=Date.now();if(!G.current)G.current=r,S.current=r;else{const c=r-S.current;L(g=>g+c),S.current=r}const n=f.clone(),p=T(d,t,e);o(c=>[...c,{white:p,black:""}]);const b=i.find(c=>c.x===t&&c.y===e);if((b==null?void 0:b.castling)==="kingside"?(n.move(d.matrixPosition,{x:6,y:e}),n.getPieceAt(7,e)&&n.move({x:7,y:e},{x:5,y:e})):(b==null?void 0:b.castling)==="queenside"?(n.move(d.matrixPosition,{x:2,y:e}),n.getPieceAt(0,e)&&n.move({x:0,y:e},{x:3,y:e})):n.move(d.matrixPosition,{x:t,y:e}),d.constructor.type==="pawn"){const c=n.getPieceAt(t,e);if(c.white&&c.matrixPosition.y===0||!c.white&&c.matrixPosition.y===7){console.log("Pawn promotion triggered for:",c),D({board:n,pawn:c});return}}y(n),P(null);const N=K(n,!1);if(N){w(N);return}v(!1),setTimeout(()=>{const g=U(n,3,!1).move;if(g){const A=n.getPieceAt(g.from.x,g.from.y),M=T(A,g.to.x,g.to.y),B=W(n,g);if(B!==n){y(B),o($=>{const H=$.length-1,ce={...$[H],black:M};return[...$.slice(0,H),ce]});const F=K(B,!0);F&&w(F)}else w("Game over: AI resigns")}else w("Game over: AI resigns");v(!0)},500);return}const u=f.getPieceAt(t,e);u&&u.white===Z?P(u):P(null)},K=(t,e)=>{let i=[];return t.pieces.forEach(u=>{u.white===e&&(i=i.concat(Q(u,t)))}),i.length===0?O(t,e)?e?"Black wins by checkmate":"White wins by checkmate":"Draw by stalemate":null},O=(t,e)=>{const i=t.pieces.find(n=>n.constructor.type==="king"&&n.white===e);if(!i)return!1;let u=[];t.pieces.forEach(n=>{n.white!==e&&(u=u.concat(n.generateMoves(t)))});const r=u.some(n=>n.x===i.matrixPosition.x&&n.y===i.matrixPosition.y);return r&&console.log(`King (${i.white?"White":"Black"}) is in check`),r},le=d?Q(d,f):[];return m.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[m.jsx("div",{className:"chessboard",children:Array(8).fill().map((t,e)=>Array(8).fill().map((i,u)=>m.jsxs("div",{className:`square ${(e+u)%2===0?"light":"dark"}`,onClick:()=>ae(u,e),style:{position:"relative"},children:[X(u,e,le)&&m.jsx("div",{style:{position:"absolute",width:"20px",height:"20px",backgroundColor:"rgba(0,255,0,0.4)",borderRadius:"50%",zIndex:1}}),f.pieces.map((r,n)=>{if(r&&r.matrixPosition.x===u&&r.matrixPosition.y===e){const p=r.constructor.type==="king"&&O(f,r.white);return m.jsxs("span",{className:"piece",style:{position:"relative",zIndex:2,border:d===r?"2px solid yellow":"none",borderRadius:"50%"},children:[p&&m.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid red",borderRadius:"50%",boxSizing:"border-box",pointerEvents:"none",zIndex:3}}),r.white&&s[r.constructor.name.toLowerCase()]?m.jsx("img",{src:ne(r),alt:r.constructor.name,style:{width:"100%",height:"100%"}}):r.render()]},n)}return null})]},`square-${e}-${u}`)))}),j&&m.jsx("div",{className:"promotion-modal",style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(46, 46, 46, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10},children:m.jsx("div",{className:"promotion-container",style:{backgroundColor:"rgba(46, 46, 46, 0.9)",padding:"20px",borderRadius:"8px",display:"flex",gap:"10px"},children:["Queen","Rook","Bishop","Knight"].map(t=>{const e=t.toLowerCase(),i=s&&s[e]?E[s[e].replace("images/","").replace(".png","")]:be[t];return m.jsx("img",{src:i,alt:t,style:{width:"50px",height:"50px",cursor:"pointer",border:"2px solid transparent"},onClick:()=>re(t)},t)})})}),k&&m.jsx("div",{className:"modal",children:m.jsxs("div",{className:"modal-content",children:[m.jsx("h2",{children:k}),m.jsx("div",{className:"modal-buttons",style:{marginTop:"20px"},children:m.jsx("button",{onClick:ie,children:"Restart"})})]})})]})},Ie=x.forwardRef(Ae);export{Ie as default};
